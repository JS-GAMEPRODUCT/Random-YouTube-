<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>YouTube Random (5 ans, sans Shorts)</title>

  <style>
    /* ===== BASE PAGE ===== */
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;

      background: radial-gradient(
        circle at top,
        #3a0f12 0%,
        #1b0709 45%,
        #0e0405 100%
      );

      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    /* ===== LOGO APP ===== */
    .logo-app {
      position: fixed;
      top: 22px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 10px;

      font-family: "Arial Black", Impact, sans-serif;
      font-size: 32px;
      letter-spacing: 1.2px;
      user-select: none;
      z-index: 10;
      animation: logoProIn 380ms cubic-bezier(0.22, 0.61, 0.36, 1) both;
    }

    .logo-yt { color: #ffffff; text-shadow: 0 0 6px rgba(255,255,255,0.15); }
    .logo-accent {
      width: 6px;
      height: 26px;
      background: linear-gradient(#ff3b3b, #b31217);
      border-radius: 3px;
    }
    .logo-rd { color: #ff2e2e; text-shadow: 0 0 14px rgba(255,0,0,0.45); }

    @keyframes logoProIn {
      from { opacity: 0; transform: translateX(-50%) translateY(-8px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @media (prefers-reduced-motion: reduce) {
      .logo-app { animation: none; }
    }

    /* ===== BOUTON ===== */
    .cartoon-btn {
      font-family: "Arial Black", Impact, sans-serif;
      font-size: 30px;
      color: #fff;
      padding: 18px 42px;
      background: linear-gradient(#c4161c, #9e1216);
      border: 4px solid #7a0e12;
      border-radius: 18px;
      cursor: pointer;
      text-shadow: 2px 2px 0 #5a0b0e;
      box-shadow: 0 6px 0 #7a0e12, 0 10px 20px rgba(0,0,0,0.45);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .cartoon-btn:hover { transform: scale(1.06); filter: brightness(1.08); }
    .cartoon-btn:active {
      transform: translateY(4px);
      box-shadow: 0 2px 0 #7a0e12, 0 6px 10px rgba(0,0,0,0.4);
    }

    /* ===== STATUS ===== */
    #status {
      margin-top: 16px;
      font-size: 14px;
      color: #e0e0e0;
      white-space: pre-line;
      text-align: center;
      padding: 0 16px;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 768px) {
      .logo-app { font-size: 26px; top: 16px; }
      .logo-accent { height: 22px; }
      .cartoon-btn { font-size: 26px; padding: 20px 36px; }
      #status { font-size: 15px; }
    }
  </style>
</head>

<body>

  <!-- LOGO -->
  <div class="logo-app">
    <span class="logo-yt">YouTube</span>
    <span class="logo-accent"></span>
    <span class="logo-rd">Random</span>
  </div>

  <!-- BOUTON -->
  <button id="random-video-btn" class="cartoon-btn">Fuze III</button>

  <!-- STATUS -->
  <div id="status">PrÃªt.</div>

  <!-- ===== SCRIPT COMPLET ===== -->
  <script>
    /* ========= CONFIG ========= */
    const apiKey = "AIzaSyBVx63xYeRm34oQIsCigJozDp9hIoRLhxo";      // ðŸ”‘ mets ta clÃ© API
    const handleOrChannel = "@FuzeIII";   // chaÃ®ne
    const YEARS_BACK = 5;
    const MIN_SECONDS = 61;

    const STRATA = 10;
    const MAX_PAGES_TO_INDEX = 120;

    const CACHE_TTL_MS = 24 * 60 * 60 * 1000;
    const CACHE_KEY = `yt_pool_${handleOrChannel}_${YEARS_BACK}y_${MIN_SECONDS}s`;

    const btn = document.getElementById("random-video-btn");
    const statusEl = document.getElementById("status");
    const setStatus = (m) => statusEl.textContent = m;

    /* ========= UTILS ========= */
    function isoDurationToSeconds(iso) {
      const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      return (+(m?.[1]||0))*3600 + (+(m?.[2]||0))*60 + (+(m?.[3]||0));
    }

    async function fetchJson(url) {
      const r = await fetch(url);
      const d = await r.json();
      if (!r.ok) throw new Error(d?.error?.message || "Erreur API");
      return d;
    }

    function cutoffMs(years) {
      const d = new Date(); d.setFullYear(d.getFullYear() - years); return d.getTime();
    }

    function loadCache() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const o = JSON.parse(raw);
        if (Date.now() - o.ts > CACHE_TTL_MS) return null;
        return o.pool;
      } catch { return null; }
    }

    function saveCache(pool) {
      localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), pool }));
    }

    /* ========= YOUTUBE ========= */
    async function resolveChannelId(input) {
      if (/^UC[a-zA-Z0-9_-]{20,}$/.test(input)) return input;
      const q = input.replace(/^@/, "");
      try {
        const u = `https://www.googleapis.com/youtube/v3/channels?part=id&forHandle=${q}&key=${apiKey}`;
        const d = await fetchJson(u);
        if (d.items?.[0]?.id) return d.items[0].id;
      } catch {}
      const u2 = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&maxResults=1&q=${q}&key=${apiKey}`;
      const d2 = await fetchJson(u2);
      return d2.items[0].id.channelId;
    }

    async function getUploadsId(channelId) {
      const u = `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${channelId}&key=${apiKey}`;
      const d = await fetchJson(u);
      return d.items[0].contentDetails.relatedPlaylists.uploads;
    }

    async function buildPool() {
      const cached = loadCache();
      if (cached) {
        setStatus(`Cache OK (${cached.length} vidÃ©os)`);
        return cached;
      }

      setStatus("Construction du poolâ€¦");
      const channelId = await resolveChannelId(handleOrChannel);
      const uploadsId = await getUploadsId(channelId);

      const cutoff = cutoffMs(YEARS_BACK);
      let pageToken = "";
      let pages = [];

      for (let i = 0; i < MAX_PAGES_TO_INDEX; i++) {
        const u = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=${uploadsId}&maxResults=50${pageToken ? "&pageToken="+pageToken : ""}&key=${apiKey}`;
        const d = await fetchJson(u);
        const items = d.items || [];
        if (!items.length) break;

        const ids = items
          .filter(v => new Date(v.snippet.publishedAt).getTime() >= cutoff)
          .map(v => v.contentDetails.videoId);

        if (ids.length) pages.push(ids);
        if (!d.nextPageToken) break;
        pageToken = d.nextPageToken;
      }

      const sample = [];
      for (let i = 0; i < STRATA; i++) {
        const slice = pages[Math.floor(Math.random() * pages.length)];
        if (slice) sample.push(...slice);
      }

      const longVideos = [];
      for (let i = 0; i < sample.length; i += 50) {
        const chunk = sample.slice(i, i+50);
        const u = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${chunk.join(",")}&key=${apiKey}`;
        const d = await fetchJson(u);
        d.items.forEach(v => {
          if (isoDurationToSeconds(v.contentDetails.duration) >= MIN_SECONDS)
            longVideos.push(v.id);
        });
      }

      saveCache(longVideos);
      setStatus(`Pool crÃ©Ã© (${longVideos.length} vidÃ©os)`);
      return longVideos;
    }

    /* ========= CLICK ========= */
    btn.addEventListener("click", async () => {
      const tab = window.open("about:blank", "_blank");
      try {
        const pool = await buildPool();
        const id = pool[Math.floor(Math.random() * pool.length)];
        tab.location.href = `https://www.youtube.com/watch?v=${id}`;
      } catch (e) {
        setStatus("Erreur : " + e.message);
        if (tab) tab.close();
      }
    });
  </script>

</body>
</html>
