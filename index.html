<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>YouTube Random ‚Äî Menu + Favoris + Random</title>

  <style>
    :root{
      --bg1:#3a0f12; --bg2:#1b0709; --bg3:#0e0405;
      --stroke: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --shadow: 0 18px 55px rgba(0,0,0,0.45);
      --accent:#ff2e2e;
      --gold:#ffd24a;
      --card: rgba(255,255,255,0.07);
      --card2: rgba(255,255,255,0.10);
      color-scheme: dark;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, var(--bg1) 0%, var(--bg2) 45%, var(--bg3) 100%);
      overflow:hidden;
    }

    /* Background glow (slightly richer) */
    .bg-glow{
      position:fixed; inset:-25%;
      background:
        radial-gradient(circle at 18% 18%, rgba(255,46,46,0.22), transparent 56%),
        radial-gradient(circle at 80% 30%, rgba(255,255,255,0.10), transparent 55%),
        radial-gradient(circle at 65% 80%, rgba(255,46,46,0.12), transparent 58%),
        radial-gradient(circle at 25% 85%, rgba(255,255,255,0.06), transparent 55%);
      filter: blur(10px);
      pointer-events:none;
      z-index:0;
    }

    /* ===== TOP BAR (mobile-app feeling) ===== */
    .topbar{
      position:fixed;
      top: calc(10px + env(safe-area-inset-top));
      left: 50%;
      transform: translateX(-50%);
      width: min(720px, 94vw);
      z-index:50;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      box-shadow: 0 18px 55px rgba(0,0,0,0.35);
      padding: 12px 14px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }

    .brand-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand-mark{
      width:44px; height:44px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), transparent 55%),
                  linear-gradient(180deg, rgba(255,46,46,0.38), rgba(0,0,0,0.10));
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 12px 26px rgba(0,0,0,0.35);
      flex:0 0 auto;
    }
    .brand-mark svg{ width:22px; height:22px; fill:#fff; opacity:.95; }
    .brand-text{ min-width:0; }
    .brand-title{
      font-family: "Arial Black", Impact, sans-serif;
      letter-spacing: .6px;
      font-size: 18px;
      line-height: 1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand-title .yt{ color:#fff; text-shadow:0 0 10px rgba(255,255,255,0.12); }
    .brand-title .sep{
      display:inline-block; width:6px; height:16px; margin:0 6px -2px 6px;
      background: linear-gradient(#ff3b3b,#b31217);
      border-radius: 3px;
    }
    .brand-title .rd{ color: var(--accent); text-shadow:0 0 14px rgba(255,0,0,0.38); }
    .brand-sub{
      margin-top:2px;
      font-size: 12px;
      color: rgba(255,255,255,0.66);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .brand-chip{
      flex:0 0 auto;
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      color: rgba(255,255,255,0.80);
      font-size: 12px;
      font-weight: 800;
      user-select:none;
    }
    .brand-chip .dot{
      width:8px; height:8px; border-radius:50%;
      background: rgba(255,46,46,0.9);
      box-shadow: 0 0 14px rgba(255,46,46,0.45);
    }

    /* App layout */
    .app{
      position:relative; z-index:1;
      width:100%; height:100vh;
      display:flex; align-items:flex-start; justify-content:center;
      padding: calc(92px + env(safe-area-inset-top)) 16px 24px 16px; /* topbar space */
      overflow:hidden;
    }

    .page{
      width:min(720px, 94vw);
      max-height: calc(100vh - 130px - env(safe-area-inset-top));
      display:none;
      animation: fadeIn 180ms ease both;
    }
    .page.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }

    /* Small top row on sub-pages */
    .page-top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin: 6px 4px 12px 4px;
    }
    .back-btn{
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer; border:none;
      background:rgba(0,0,0,0.20);
      color:#fff; font-weight:900;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      transition: filter .12s ease, transform .12s ease;
    }
    .back-btn:hover{ filter:brightness(1.10); }
    .back-btn:active{ transform:translateY(1px); }

    .page-title{
      font-family:"Arial Black",Impact,sans-serif;
      letter-spacing:.5px; font-size:16px; opacity:0.95;
    }

    /* Card container */
    .menu-card{
      border-radius:24px;
      border:1px solid rgba(255,255,255,0.13);
      background: rgba(255,255,255,0.07);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:16px;
      overflow:hidden;
    }

    /* ===== HOME HERO ===== */
    .home-hero{
      padding: 12px 4px 14px 4px;
    }
    .home-hero h1{
      margin:0;
      font-size: 20px;
      letter-spacing: .2px;
      font-weight: 950;
    }
    .home-hero p{
      margin: 6px 0 0 0;
      font-size: 13px;
      color: rgba(255,255,255,0.70);
      line-height: 1.35;
    }

    /* ===== MENU LIST (more "native") ===== */
    .menu-list{ display:flex; flex-direction:column; gap:10px; }

    .menu-item{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
    }
    .menu-item:hover{ filter:brightness(1.08); }
    .menu-item:active{ transform:translateY(1px); }

    .menu-left{ display:flex; align-items:center; gap:12px; min-width:0; }

    /* Modern icon container */
    .icon{
      width:44px; height:44px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 22px rgba(0,0,0,0.28);
      flex:0 0 auto;
    }
    .icon svg{ width:22px; height:22px; fill: rgba(255,255,255,0.92); }

    /* Accent ring per item */
    .menu-item[data-go="page-channels"] .icon{ outline: 2px solid rgba(255,46,46,0.35); }
    .menu-item[data-go="page-favs"] .icon{ outline: 2px solid rgba(255,210,74,0.35); }
    .menu-item[data-go="page-help"] .icon{ outline: 2px solid rgba(93,167,255,0.28); }

    .menu-text{ min-width:0; }
    .menu-text .t1{
      font-size:16px; font-weight:950; color:rgba(255,255,255,0.93);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .menu-text .t2{
      margin-top:2px; font-size:12.5px; color:rgba(255,255,255,0.62);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .chev{
      width:32px; height:32px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      color: rgba(255,255,255,0.70);
      font-size: 20px;
      flex:0 0 auto;
    }

    .footer{
      margin-top:12px;
      text-align:center;
      color:rgba(255,255,255,0.55);
      font-size:12px;
    }
    .hidden{ display:none !important; }

    /* ‚úÖ Zone scrollable */
    .scroll{
      max-height:60vh;
      overflow:auto;
      padding-right:4px;
      padding-bottom:105px;
      overscroll-behavior: contain;
    }
    .scroll::-webkit-scrollbar{ width:10px; }
    .scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.16);
      border-radius:10px;
      border:2px solid rgba(0,0,0,0.15);
    }

    /* =========================
       ‚úÖ CHANNEL CARD + ACCORDION (unchanged)
       ========================= */
    .channel-item{
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
      margin-bottom:12px;
      overflow:hidden;
    }
    .channel-item:hover{ filter:brightness(1.08); }
    .channel-item:active{ transform:translateY(1px); }

    .channel-main{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 14px;
    }

    .channel-left{ display:flex; align-items:center; gap:14px; min-width:0; flex:1 1 auto; }

    .channel-avatar{
      width:52px; height:52px; border-radius:50%;
      object-fit:cover;
      border:2px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      flex:0 0 auto;
    }

    .channel-fallback{
      width:52px; height:52px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-family:"Arial Black",Impact,sans-serif; font-size:18px; color:#fff;
      background: linear-gradient(#c4161c,#9e1216);
      border:2px solid #7a0e12;
      box-shadow: 0 10px 18px rgba(0,0,0,0.35);
      text-shadow: 1px 1px 0 #5a0b0e;
      flex:0 0 auto;
    }

    .channel-text{ min-width:0; flex:1 1 auto; }
    .channel-name{
      font-size:18px; font-weight:900; color:#fff; letter-spacing:.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .channel-sub{
      font-size:12px; color:rgba(255,255,255,0.70); margin-top:4px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .channel-right{ display:flex; align-items:center; gap:10px; flex:0 0 auto; }

    .star-btn{
      width:34px; height:34px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
      user-select:none;
    }
    .star-btn:hover{ filter:brightness(1.08); }
    .star-btn:active{ transform:translateY(1px); }

    .star{ font-size:18px; line-height:1; color: rgba(255,255,255,0.55); }
    .star.fav{ color: var(--gold); text-shadow: 0 0 10px rgba(255,210,74,0.35); }

    .chev-btn{
      width:34px; height:34px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      transition: filter .12s ease, transform .18s ease;
      color:rgba(255,255,255,0.65);
      font-size:22px;
      line-height:1;
    }
    .chev-btn:hover{ filter:brightness(1.08); }
    .chev-btn:active{ transform:translateY(1px); }
    .channel-item.open .chev-btn{ transform: rotate(90deg); }

    .channel-expand{
      max-height:0;
      overflow:hidden;
      transition: max-height .22s ease;
      border-top: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.12);
    }
    .expand-inner{ padding:12px 14px 14px 14px; }

    .latest-title, .random-title{
      font-weight:900;
      color:rgba(255,255,255,0.90);
      font-size:13px;
      margin-bottom:10px;
    }
    .random-title{ margin:14px 0 10px 0; }

    .latest-row, .random-row{ display:flex; gap:12px; align-items:flex-start; }

    .latest-thumb{
      width:160px; height:90px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      object-fit:cover;
      background: rgba(255,255,255,0.06);
      cursor:pointer;
      flex:0 0 auto;
      transition: filter .12s ease, transform .12s ease;
    }
    .latest-thumb:hover{ filter:brightness(1.06); }
    .latest-thumb:active{ transform:translateY(1px); }

    .latest-meta, .random-meta{ min-width:0; }

    .latest-video-title{
      font-weight:900;
      font-size:14px;
      color:rgba(255,255,255,0.92);
      line-height:1.25;
      cursor:pointer;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
      transition: filter .12s ease;
    }
    .latest-video-title:hover{ filter:brightness(1.08); }

    .latest-hint, .random-hint{
      margin-top:6px;
      font-size:12px;
      color:rgba(255,255,255,0.60);
    }

    .latest-loading{
      font-size:12px;
      color:rgba(255,255,255,0.65);
      padding:10px 0;
    }
    .latest-error{
      font-size:12px;
      color:rgba(255,120,120,0.95);
      padding:10px 0;
      font-weight:800;
    }

    .random-thumb{
      width:160px; height:90px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.14), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.32));
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex:0 0 auto;
      transition: filter .12s ease, transform .12s ease;
      position:relative;
      overflow:hidden;
    }
    .random-thumb::before{
      content:"?";
      font-family:"Arial Black",Impact,sans-serif;
      font-size:46px;
      color:rgba(255,255,255,0.85);
      text-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    .random-thumb:hover{ filter:brightness(1.06); }
    .random-thumb:active{ transform:translateY(1px); }

    .random-action{
      font-weight:900;
      font-size:14px;
      color:rgba(255,255,255,0.92);
      line-height:1.25;
      cursor:pointer;
      transition: filter .12s ease;
    }
    .random-action:hover{ filter:brightness(1.08); }

    .row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; justify-content:center; }
    .small-btn{
      font-weight:850; font-size:14px;
      padding:10px 14px; border-radius:14px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(0,0,0,0.22); color:#fff;
      cursor:pointer; transition:filter .12s ease, transform .12s ease;
    }
    .small-btn:hover{ filter:brightness(1.10); }
    .small-btn:active{ transform:translateY(1px); }

    /* Toast */
    .toast-wrap{
      position:fixed; left:50%; bottom: calc(18px + env(safe-area-inset-bottom)); transform:translateX(-50%);
      z-index:10000; display:flex; flex-direction:column; gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      min-width: min(520px, 92vw);
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(15,5,6,0.88);
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color:rgba(255,255,255,0.90);
      font-weight:900;
      text-align:center;
      animation: toastIn 180ms ease both;
    }
    @keyframes toastIn{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }

    /* Modal historique */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.55);
      display:flex; align-items:center; justify-content:center; padding:18px; z-index:9999; }
    .modal-card{
      width:min(900px,94vw); max-height:78vh; overflow:hidden;
      border-radius:16px; border:2px solid rgba(255,255,255,0.12);
      background:rgba(15,5,6,0.92); box-shadow:0 20px 50px rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 14px 10px 14px; border-bottom:1px solid rgba(255,255,255,0.10);
    }
    .modal-title{ font-family:"Arial Black",Impact,sans-serif; color:#fff; font-size:20px; letter-spacing:0.6px; }
    .modal-actions{ display:flex; gap:10px; flex-wrap:wrap; padding:12px 14px 6px 14px; }
    .modal-sub{ padding:0 14px 10px 14px; color:rgba(255,255,255,0.75); font-size:13px; }
    .modal-list{ padding:0 14px 14px 14px; overflow:auto; max-height:calc(78vh - 120px); }

    .history-item{
      display:grid; grid-template-columns:120px 1fr auto;
      gap:10px; align-items:center;
      padding:10px; border-radius:12px; margin-bottom:8px;
      background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08);
    }
    .thumb{
      width:120px; height:90px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      object-fit:cover; background:rgba(255,255,255,0.05);
    }
    .history-left{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .history-title{ color:rgba(255,255,255,0.95); font-weight:900; font-size:14px; line-height:1.2; }
    .history-id{ font-family:monospace; color:rgba(255,255,255,0.8); font-size:12px; }
    .history-link{ color:#ff4d4d; text-decoration:none; word-break:break-all; font-size:13px; }
    .history-link:hover{ text-decoration:underline; }

    @media (max-width:768px){
      .topbar{ top: calc(8px + env(safe-area-inset-top)); }
      .brand-mark{ width:42px; height:42px; }
      .brand-title{ font-size:17px; }
      .app{ padding-top: calc(90px + env(safe-area-inset-top)); }
      .scroll{ max-height:58vh; padding-bottom:115px; }
      .modal-card{ max-height:84vh; }
      .modal-list{ max-height:calc(84vh - 130px); }
      .history-item{ grid-template-columns:96px 1fr; grid-template-rows:auto auto; }
      .thumb{ width:96px; height:72px; }
      .history-item .small-btn{ grid-column:1 / -1; justify-self:end; }
      .latest-thumb, .random-thumb{ width:140px; height:78px; }
    }

    /* ‚úÖ iOS STABLE */
    @supports (-webkit-touch-callout: none) {
      .topbar, .menu-card, .menu-item, .channel-item, .toast, .modal-card{
        -webkit-backdrop-filter: none !important;
        backdrop-filter: none !important;
      }
      .topbar{
        background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08)) !important;
      }
      .menu-card{
        background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08)) !important;
        box-shadow: 0 18px 55px rgba(0,0,0,0.35) !important;
      }
      .menu-item{ background: rgba(255,255,255,0.14) !important; }
      .channel-item{ background: rgba(255,255,255,0.12) !important; }
      .toast{ background: rgba(15,5,6,0.92) !important; }
    }
  </style>
</head>

<body>
  <div class="bg-glow"></div>

  <!-- ‚úÖ Top bar (remplace le logo flottant + supprime l'espace vide) -->
  <header class="topbar" aria-label="YouTube Random">
    <div class="brand">
      <div class="brand-left">
        <div class="brand-mark" aria-hidden="true">
          <!-- Play icon -->
          <svg viewBox="0 0 24 24">
            <path d="M8 5.5v13l11-6.5L8 5.5z"></path>
          </svg>
        </div>
        <div class="brand-text">
          <div class="brand-title">
            <span class="yt">YouTube</span><span class="sep"></span><span class="rd">Random</span>
          </div>
          <div class="brand-sub">Choisis une cha√Æne, puis lance une vid√©o au hasard</div>
        </div>
      </div>
      <div class="brand-chip" title="Mode appli">
        <span class="dot"></span>
        <span>Mobile-first</span>
      </div>
    </div>
  </header>

  <div class="app">

    <!-- PAGE MENU -->
    <section id="page-home" class="page active">
      <div class="menu-card">

        <div class="home-hero">
          <h1>Menu</h1>
          <p>Une interface simple, pens√©e comme une appli. Tout se joue dans <b>Cha√Ænes</b> : derni√®re vid√©o + random (sans shorts).</p>
        </div>

        <div class="menu-list">

          <div class="menu-item" data-go="page-channels" role="button" aria-label="Aller vers Cha√Ænes">
            <div class="menu-left">
              <div class="icon" aria-hidden="true">
                <!-- Users icon -->
                <svg viewBox="0 0 24 24">
                  <path d="M16 11c1.66 0 3-1.57 3-3.5S17.66 4 16 4s-3 1.57-3 3.5S14.34 11 16 11zm-8 0c1.66 0 3-1.57 3-3.5S9.66 4 8 4 5 5.57 5 7.5 6.34 11 8 11zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.95 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
              </div>
              <div class="menu-text">
                <div class="t1">Cha√Ænes</div>
                <div class="t2">S√©lectionner un youtubeur</div>
              </div>
            </div>
            <div class="chev" aria-hidden="true">‚Ä∫</div>
          </div>

          <div class="menu-item" data-go="page-favs" role="button" aria-label="Aller vers Favoris">
            <div class="menu-left">
              <div class="icon" aria-hidden="true">
                <!-- Star icon -->
                <svg viewBox="0 0 24 24">
                  <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
              </div>
              <div class="menu-text">
                <div class="t1">Favoris</div>
                <div class="t2">Tes cha√Ænes favorites</div>
              </div>
            </div>
            <div class="chev" aria-hidden="true">‚Ä∫</div>
          </div>

          <div class="menu-item" data-go="page-help" role="button" aria-label="Aller vers Comment √ßa marche ?">
            <div class="menu-left">
              <div class="icon" aria-hidden="true">
                <!-- Help icon -->
                <svg viewBox="0 0 24 24">
                  <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/>
                </svg>
              </div>
              <div class="menu-text">
                <div class="t1">Comment √ßa marche ?</div>
                <div class="t2">Explication rapide</div>
              </div>
            </div>
            <div class="chev" aria-hidden="true">‚Ä∫</div>
          </div>

        </div>

        <div class="footer">YouTube Random ‚Äî Menu</div>
      </div>
    </section>

    <!-- PAGE CHA√éNES -->
    <section id="page-channels" class="page">
      <div class="page-top">
        <button class="back-btn" data-back="page-home">‚Üê Retour</button>
        <div class="page-title">Cha√Ænes</div>
        <div style="width:92px;"></div>
      </div>

      <div class="menu-card">
        <div id="channels-list" class="scroll"></div>

        <div class="row">
          <button id="rebuild-all-btn" class="small-btn">Rebuild caches</button>
          <button id="rebuild-latest-btn" class="small-btn">Rebuild derni√®res vid√©os</button>
          <button id="reset-seen-btn" class="small-btn">Reset historique</button>
          <button id="history-btn" class="small-btn">Historique</button>
        </div>
      </div>
    </section>

    <!-- PAGE FAVORIS -->
    <section id="page-favs" class="page">
      <div class="page-top">
        <button class="back-btn" data-back="page-home">‚Üê Retour</button>
        <div class="page-title">Favoris</div>
        <div style="width:92px;"></div>
      </div>

      <div class="menu-card">
        <div id="favorites-list" class="scroll"></div>
        <div id="favorites-empty" class="footer hidden">Aucun favori pour l‚Äôinstant.</div>
      </div>
    </section>

    <!-- PAGE HELP -->
    <section id="page-help" class="page">
      <div class="page-top">
        <button class="back-btn" data-back="page-home">‚Üê Retour</button>
        <div class="page-title">Comment √ßa marche ?</div>
        <div style="width:92px;"></div>
      </div>

      <div class="menu-card">
        <div style="color:rgba(255,255,255,0.70); font-size:13px; line-height:1.45;">
          ‚Ä¢ Va dans ‚ÄúCha√Ænes‚Äù.<br>
          ‚Ä¢ Clique sur une carte : √ßa ouvre le d√©tail (dernier upload + random).<br>
          ‚Ä¢ Clique sur ‚ÄúLance une vid√©o random‚Äù dans le d√©tail pour lancer une vid√©o (sans shorts).<br>
          ‚Ä¢ Fuze III = tirage 50/50 entre Fuze III et Fiouse.<br>
          ‚Ä¢ L‚Äô√©toile ‚≠ê ajoute/retire le bouton des Favoris.<br>
          ‚Ä¢ Rebuild caches = rebuild pools random (48h).<br>
          ‚Ä¢ Rebuild derni√®res vid√©os = force la MAJ des derni√®res vid√©os (cache 6h).<br>
          ‚Ä¢ Sur t√©l√©phone : ouverture tente l‚Äôapp YouTube, sinon navigateur.
        </div>
      </div>
    </section>

  </div>

  <!-- TOAST -->
  <div id="toast-wrap" class="toast-wrap"></div>

  <!-- MODAL HISTORIQUE -->
  <div id="history-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="history-title">
    <div class="modal-card">
      <div class="modal-header">
        <div id="history-title" class="modal-title">Historique</div>
        <button id="history-close" class="small-btn">Fermer</button>
      </div>

      <div class="modal-actions">
        <button id="history-copy-all" class="small-btn">Copier tout</button>
        <button id="history-clear" class="small-btn">Vider historique</button>
      </div>

      <div id="history-count" class="modal-sub"></div>
      <div id="history-list" class="modal-list"></div>
    </div>
  </div>

  <script>
    /* ========= NAVIGATION ========= */
    function showPage(id){
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      const el = document.getElementById(id);
      if(el) el.classList.add("active");
      if(id === "page-favs") renderFavorites();
      if(id === "page-channels") renderChannels();
    }

    document.addEventListener("click", (e)=>{
      const go = e.target.closest("[data-go]");
      if(go) showPage(go.dataset.go);
      const back = e.target.closest("[data-back]");
      if(back) showPage(back.dataset.back);
    });

    /* ========= TOAST ========= */
    const toastWrap = document.getElementById("toast-wrap");
    function toast(msg){
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = msg;
      toastWrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; }, 1500);
      setTimeout(()=>{ el.remove(); }, 1900);
    }

    /* ========= OPEN YT (APP FIRST, FALLBACK WEB) ========= */
    function openYouTubePreferApp(videoId){
      const webUrl = `https://www.youtube.com/watch?v=${videoId}`;
      const appUrl = `youtube://watch?v=${videoId}`;
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      if(!isMobile){
        window.open(webUrl, "_blank", "noopener,noreferrer");
        return;
      }

      const start = Date.now();
      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = appUrl;
      document.body.appendChild(iframe);

      setTimeout(() => {
        try{ document.body.removeChild(iframe); }catch{}
        if(document.visibilityState === "visible" && (Date.now() - start) < 2500){
          window.location.href = webUrl;
        }
      }, 900);
    }

    /* ========= CONFIG ========= */
    const apiKey = "AIzaSyBVx63xYeRm34oQIsCigJozDp9hIoRLhxo"; // <-- Mets ta cl√© ici

    function normalizeChannelId(id){
      const s = String(id || "").trim();
      if(s.startsWith("UC")) return s;
      if(s.length === 22) return "UC" + s;
      return s;
    }

    const CHANNEL_FUZE3_ID   = normalizeChannelId("UCfznY5SlSoZoXN0-kBPtCdg");
    const CHANNEL_FIOUSE_ID  = normalizeChannelId("UCBIVKUsOGwCg8RNpucEGp_g");
    const CHANNEL_AMIXEM_ID  = normalizeChannelId("UCgvqvBoSHB1ctlyyhoHrGwQ");
    const CHANNEL_SQUEEZIE_ID= normalizeChannelId("UCWeg2Pkate69NFdBeuRFTAw");
    const CHANNEL_MEC_ID     = normalizeChannelId("UCDPK_MTu3uTUFJXRVcTJcEw");
    const CHANNEL_INOXTAG_ID = normalizeChannelId("UCL9aTJb0ur4sovxcppAopEw");
    const CHANNEL_JOYCA_ID   = normalizeChannelId("UCow2IGnug1l3Xazkrc5jM_Q");
    const CHANNEL_MASTU_ID   = normalizeChannelId("UCahaFPP6v3WCfK5Tjao0B7A");

    const MIN_SECONDS = 61;                 // anti-shorts
    const CACHE_TTL_MS = 48 * 60 * 60 * 1000;

    // Limites (PAR CHA√éNE)
    const MAX_PAGES = 200;
    const MAX_VIDEOS = 6000;

    // D√©finition des cha√Ænes (fen√™tres)
    const CH_FUZE3  = { key:"fuze3",  name:"Fuze III", id:CHANNEL_FUZE3_ID,  cutoffType:"yearsBack", yearsBack:6 };
    const CH_FIOUSE = { key:"fiouse", name:"Fiouse",  id:CHANNEL_FIOUSE_ID, cutoffType:"sinceIso",  sinceIso:"2023-01-01T00:00:00Z" };
    const CH_AMIXEM = { key:"amixem", name:"Amixem",  id:CHANNEL_AMIXEM_ID, cutoffType:"yearsBack", yearsBack:6 };
    const CH_SQUEEZIE = { key:"squeezie", name:"Squeezie", id:CHANNEL_SQUEEZIE_ID, cutoffType:"yearsBack", yearsBack:7 };
    const CH_MEC      = { key:"mec", name:"MacFly et Carlito", id:CHANNEL_MEC_ID, cutoffType:"yearsBack", yearsBack:4 };
    const CH_INOXTAG  = { key:"inoxtag", name:"Inoxtag", id:CHANNEL_INOXTAG_ID, cutoffType:"yearsBack", yearsBack:5 };
    const CH_JOYCA    = { key:"joyca", name:"Joyca", id:CHANNEL_JOYCA_ID, cutoffType:"yearsBack", yearsBack:5 };
    const CH_MASTU    = { key:"mastu", name:"Mastu", id:CHANNEL_MASTU_ID, cutoffType:"yearsBack", yearsBack:5 };

    const CHANNELS_ALL = [CH_FUZE3, CH_FIOUSE, CH_AMIXEM, CH_SQUEEZIE, CH_MEC, CH_INOXTAG, CH_JOYCA, CH_MASTU];

    let isPicking = false;

    /* ========= UTILS ========= */
    function isoDurationToSeconds(iso){
      const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      return (+(m?.[1]||0))*3600 + (+(m?.[2]||0))*60 + (+(m?.[3]||0));
    }
    async function fetchJson(url){
      const r = await fetch(url);
      const d = await r.json();
      if(!r.ok) throw new Error(d?.error?.message || "Erreur API");
      return d;
    }
    function cutoffMsForChannel(ch){
      if (ch.cutoffType === "yearsBack"){
        const d = new Date();
        d.setFullYear(d.getFullYear() - (ch.yearsBack || 6));
        return d.getTime();
      }
      return new Date(ch.sinceIso).getTime();
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatDuration(ms){
      if(ms <= 0) return "0h";
      const s = Math.floor(ms/1000);
      const days = Math.floor(s/86400);
      const hours = Math.floor((s%86400)/3600);
      const mins = Math.floor((s%3600)/60);
      if(days > 0) return `${days}j ${hours}h`;
      if(hours > 0) return `${hours}h ${pad2(mins)}m`;
      return `${mins}m`;
    }

    /* ========= FAVORIS ========= */
    const FAV_KEY = "yt_favorites_v1";
    function loadFavorites(){
      try{
        const raw = localStorage.getItem(FAV_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveFavorites(list){ localStorage.setItem(FAV_KEY, JSON.stringify(list)); }
    function isFav(entryId){ return loadFavorites().includes(entryId); }
    function toggleFav(entryId){
      const favs = loadFavorites();
      const idx = favs.indexOf(entryId);
      if(idx >= 0){
        favs.splice(idx, 1);
        saveFavorites(favs);
        return false;
      }else{
        favs.push(entryId);
        saveFavorites(favs);
        return true;
      }
    }

    /* ========= AVATAR (API + CACHE) ========= */
    const AVATAR_TTL_MS = 30 * 24 * 60 * 60 * 1000;
    function avatarCacheKey(channelId){ return `yt_avatar_${channelId}_v1`; }
    function avatarCacheTsKey(channelId){ return `yt_avatar_${channelId}_ts_v1`; }

    function loadCachedAvatar(channelId){
      try{
        const url = localStorage.getItem(avatarCacheKey(channelId)) || "";
        const ts = Number(localStorage.getItem(avatarCacheTsKey(channelId)) || 0);
        if(!url || !ts) return "";
        if(Date.now() - ts > AVATAR_TTL_MS) return "";
        return url;
      }catch{ return ""; }
    }
    function saveCachedAvatar(channelId, url){
      try{
        localStorage.setItem(avatarCacheKey(channelId), url);
        localStorage.setItem(avatarCacheTsKey(channelId), String(Date.now()));
      }catch{}
    }
    async function fetchChannelAvatarUrl(channelId){
      const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${channelId}&key=${apiKey}`;
      const data = await fetchJson(url);
      const thumbs = data?.items?.[0]?.snippet?.thumbnails;
      return thumbs?.medium?.url || thumbs?.default?.url || thumbs?.high?.url || "";
    }
    async function ensureAvatarFor(channelId){
      const cached = loadCachedAvatar(channelId);
      if(cached) return cached;
      const avatarUrl = await fetchChannelAvatarUrl(channelId);
      if(avatarUrl) saveCachedAvatar(channelId, avatarUrl);
      return avatarUrl || "";
    }

    /* ========= KEYS ========= */
    function keysFor(ch){
      const base = `yt_${ch.key}_${ch.id}_${MIN_SECONDS}s`;
      return {
        IDS:  `${base}_pool_ids_v1`,
        META: `${base}_pool_meta_v1`,
        TS:   `${base}_pool_ts_v1`,
        SEEN: `${base}_seen_v1`
      };
    }

    /* ========= CACHE (POOLS RANDOM) ========= */
    function loadCache(ch){
      const k = keysFor(ch);
      try{
        const idsRaw = localStorage.getItem(k.IDS);
        const metaRaw = localStorage.getItem(k.META);
        const tsRaw = localStorage.getItem(k.TS);
        if(!idsRaw || !metaRaw || !tsRaw) return null;

        const poolIds = JSON.parse(idsRaw);
        const metaMap = JSON.parse(metaRaw);
        const meta = JSON.parse(tsRaw);

        if(!Array.isArray(poolIds) || !meta?.ts) return null;
        if(Date.now() - meta.ts > CACHE_TTL_MS) return null;

        return { poolIds, metaMap, meta };
      }catch{
        return null;
      }
    }

    function saveCache(ch, poolIds, metaMap, extra={}){
      const k = keysFor(ch);
      const meta = { ts: Date.now(), count: poolIds.length, ...extra };
      localStorage.setItem(k.IDS, JSON.stringify(poolIds));
      localStorage.setItem(k.META, JSON.stringify(metaMap));
      localStorage.setItem(k.TS, JSON.stringify(meta));
      return meta;
    }

    function removeFromCache(ch, videoId){
      const cached = loadCache(ch);
      if(!cached || !Array.isArray(cached.poolIds)) return;
      const idx = cached.poolIds.indexOf(videoId);
      if(idx === -1) return;
      cached.poolIds.splice(idx, 1);
      saveCache(ch, cached.poolIds, cached.metaMap, { pruned_to: cached.poolIds.length });
    }

    /* ========= HISTORIQUE ========= */
    function loadSeenList(ch){
      const k = keysFor(ch);
      try{
        const raw = localStorage.getItem(k.SEEN);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    function saveSeenList(ch, list){
      const k = keysFor(ch);
      const MAX_SEEN = 10000;
      const trimmed = list.slice(Math.max(0, list.length - MAX_SEEN));
      localStorage.setItem(k.SEEN, JSON.stringify(trimmed));
    }
    function resetSeenAll(){
      for(const ch of CHANNELS_ALL){
        const k = keysFor(ch);
        localStorage.removeItem(k.SEEN);
      }
    }

    function seenCountFor(ch){ return loadSeenList(ch).length; }
    function remainingCountFor(ch){ return loadCache(ch)?.poolIds?.length || 0; }

    function rebuildTimeLeftForGroup(group){
      const now = Date.now();
      const times = [];
      for(const ch of group){
        const cached = loadCache(ch);
        if(cached?.meta?.ts){
          const left = CACHE_TTL_MS - (now - cached.meta.ts);
          times.push(left);
        }
      }
      if(times.length === 0) return "charger une vid√©o random";
      const minLeft = Math.min(...times);
      if(minLeft <= 0) return "charger une vid√©o random";
      return formatDuration(minLeft);
    }

    /* ========= YT quota-min ========= */
    async function getUploadsPlaylistId(channelId){
      const url = `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${channelId}&key=${apiKey}`;
      const data = await fetchJson(url);
      const uploads = data?.items?.[0]?.contentDetails?.relatedPlaylists?.uploads;
      if(!uploads) throw new Error("Impossible de r√©cup√©rer la playlist Uploads.");
      return uploads;
    }

    async function collectVideoIdsUpToCutoff(uploadsPlaylistId, cutoffMs){
      let pageToken = "";
      const all = [];

      for(let page=0; page<MAX_PAGES; page++){
        const url =
          `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails`+
          `&playlistId=${uploadsPlaylistId}&maxResults=50`+
          (pageToken ? `&pageToken=${pageToken}` : "")+
          `&key=${apiKey}`;

        const data = await fetchJson(url);
        const items = data.items || [];
        if(!items.length) break;

        let reachedOld = false;

        for(const it of items){
          const publishedAt = it?.snippet?.publishedAt;
          const ms = publishedAt ? new Date(publishedAt).getTime() : null;
          const vid = it?.contentDetails?.videoId;
          if(!vid || !ms) continue;

          if(ms < cutoffMs){ reachedOld = true; break; }

          all.push(vid);
          if(all.length >= MAX_VIDEOS){ reachedOld = true; break; }
        }

        if(reachedOld) break;
        if(!data.nextPageToken) break;
        pageToken = data.nextPageToken;
      }

      return all;
    }

    async function buildMetaAndFilterNoShorts(videoIds){
      const poolIds = [];
      const metaMap = {}; // id -> [title, thumb]

      for(let i=0; i<videoIds.length; i+=50){
        const chunk = videoIds.slice(i, i+50);
        const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${chunk.join(",")}&key=${apiKey}`;
        const data = await fetchJson(url);

        for(const v of (data.items || [])){
          const id = v?.id;
          const iso = v?.contentDetails?.duration;
          if(!id || !iso) continue;

          const sec = isoDurationToSeconds(iso);
          const sn = v?.snippet;

          const thumb =
            sn?.thumbnails?.default?.url ||
            sn?.thumbnails?.medium?.url ||
            sn?.thumbnails?.high?.url ||
            "";

          const title = (sn?.title || "").trim();
          metaMap[id] = [title, thumb];

          if(sec >= MIN_SECONDS) poolIds.push(id);
        }
      }

      return { poolIds, metaMap };
    }

    async function buildPoolForChannel(ch, force=false){
      if(!force){
        const cached = loadCache(ch);
        if(cached) return cached;
      }

      toast(`Rebuild ${ch.name}‚Ä¶`);
      const cutoff = cutoffMsForChannel(ch);
      const uploadsId = await getUploadsPlaylistId(ch.id);
      const ids = await collectVideoIdsUpToCutoff(uploadsId, cutoff);
      const built = await buildMetaAndFilterNoShorts(ids);

      if(!built.poolIds.length) throw new Error(`Pool vide pour ${ch.name} (beaucoup de shorts ?).`);

      // prune d√©j√†-vu
      const seenSet = new Set(loadSeenList(ch));
      const prunedPoolIds = built.poolIds.filter(id => !seenSet.has(id));

      saveCache(ch, prunedPoolIds, built.metaMap, {
        raw: ids.length,
        pruned_from: built.poolIds.length,
        pruned_to: prunedPoolIds.length
      });

      return {
        poolIds: prunedPoolIds,
        metaMap: built.metaMap,
        meta: { ts: Date.now(), count: prunedPoolIds.length }
      };
    }

    /* ========= PICK ========= */
    function pickFromPool(ch, poolIds){
      if(!poolIds || poolIds.length === 0){
        throw new Error(`Plus de vid√©os dispo pour ${ch.name}. Fais un rebuild ou reset historique.`);
      }

      const pickedId = poolIds[Math.floor(Math.random() * poolIds.length)];

      const seen = loadSeenList(ch);
      if(!seen.includes(pickedId)){
        seen.push(pickedId);
        saveSeenList(ch, seen);
      }

      return pickedId;
    }

    /* ========= ENTRIES ========= */
    const ENTRY_FUZE_RANDOM = {
      entryId: "entry_fuze_random_50",
      title: "Fuze III",
      subtitlePrefix: "‚Ä¢ Fuze III / Fiouse",
      avatarChannelId: CHANNEL_FUZE3_ID,
      type: "group_random",
      group: [CH_FUZE3, CH_FIOUSE]
    };

    function makeSingleEntry(key, title, channel, avatarChannelId, yearsLabel){
      return {
        entryId: `entry_${key}`,
        title,
        subtitlePrefix: `‚Ä¢ ${yearsLabel}`,
        avatarChannelId,
        type: "single_random",
        channel
      };
    }

    const ENTRIES = [
      ENTRY_FUZE_RANDOM,
      makeSingleEntry("amixem",   "Amixem",            CH_AMIXEM,   CHANNEL_AMIXEM_ID,   "Amixem (6 ans)"),
      makeSingleEntry("squeezie", "Squeezie",          CH_SQUEEZIE, CHANNEL_SQUEEZIE_ID, "Squeezie (7 ans)"),
      makeSingleEntry("mec",      "MacFly et Carlito", CH_MEC,      CHANNEL_MEC_ID,      "MacFly et Carlito (4 ans)"),
      makeSingleEntry("inoxtag",  "Inoxtag",           CH_INOXTAG,  CHANNEL_INOXTAG_ID,  "Inoxtag (5 ans)"),
      makeSingleEntry("joyca",    "Joyca",             CH_JOYCA,    CHANNEL_JOYCA_ID,    "Joyca (5 ans)"),
      makeSingleEntry("mastu",    "Mastu",             CH_MASTU,    CHANNEL_MASTU_ID,    "Mastu (5 ans)")
    ];

    /* ========= LAUNCH RANDOM (seulement via bloc dans accord√©on) ========= */
    async function launchEntry(entry){
      if(isPicking) return;
      isPicking = true;

      try{
        if(entry.type === "group_random"){
          const chosen = (Math.random() < 0.5) ? entry.group[0] : entry.group[1];
          const built = await buildPoolForChannel(chosen, false);
          const vid = pickFromPool(chosen, built.poolIds);
          removeFromCache(chosen, vid);
          openYouTubePreferApp(vid);
        } else {
          const ch = entry.channel;
          const built = await buildPoolForChannel(ch, false);
          const vid = pickFromPool(ch, built.poolIds);
          removeFromCache(ch, vid);
          openYouTubePreferApp(vid);
        }

        renderChannels();
        renderFavorites();
      }catch(e){
        console.error(e);
        toast("Erreur : " + (e.message || e));
      }finally{
        isPicking = false;
      }
    }

    /* ========= STATS LINE ========= */
    function statsLineForEntry(entry){
      if(entry.type === "group_random"){
        const remaining = remainingCountFor(entry.group[0]) + remainingCountFor(entry.group[1]);
        const seen = seenCountFor(entry.group[0]) + seenCountFor(entry.group[1]);
        const timeLeft = rebuildTimeLeftForGroup(entry.group);
        return `Vid√©os dispo : ${remaining} ‚Ä¢ D√©j√† vues : ${seen} ‚Ä¢ Rebuild : ${timeLeft}`;
      } else {
        const remaining = remainingCountFor(entry.channel);
        const seen = seenCountFor(entry.channel);
        const timeLeft = rebuildTimeLeftForGroup([entry.channel]);
        return `Vid√©os dispo : ${remaining} ‚Ä¢ D√©j√† vues : ${seen} ‚Ä¢ Rebuild : ${timeLeft}`;
      }
    }

    /* =========================
       ‚úÖ DERNI√àRE VID√âO (ACCORD√âON) + CACHE 6h (ANTI-SHORTS)
       ========================= */
    const LATEST_TTL_MS = 6 * 60 * 60 * 1000;

    function latestKey(channelId){ return `yt_latest_${channelId}_v2`; }
    function latestTsKey(channelId){ return `yt_latest_${channelId}_ts_v2`; }

    function loadLatest(channelId){
      try{
        const raw = localStorage.getItem(latestKey(channelId));
        const ts = Number(localStorage.getItem(latestTsKey(channelId)) || 0);
        if(!raw || !ts) return null;
        if(Date.now() - ts > LATEST_TTL_MS) return null;
        const obj = JSON.parse(raw);
        if(!obj?.videoId) return null;
        return obj;
      }catch{ return null; }
    }

    function saveLatest(channelId, obj){
      try{
        localStorage.setItem(latestKey(channelId), JSON.stringify(obj));
        localStorage.setItem(latestTsKey(channelId), String(Date.now()));
      }catch{}
    }

    function clearLatest(channelId){
      try{
        localStorage.removeItem(latestKey(channelId));
        localStorage.removeItem(latestTsKey(channelId));
      }catch{}
    }

    async function fetchLatestVideo(channelId){
      const uploadsId = await getUploadsPlaylistId(channelId);

      const N = 10;
      const url =
        `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${uploadsId}`+
        `&maxResults=${N}&key=${apiKey}`;
      const data = await fetchJson(url);

      const items = data?.items || [];
      const ids = [];
      for(const it of items){
        const vid = it?.snippet?.resourceId?.videoId;
        if(vid) ids.push(vid);
      }
      if(!ids.length) throw new Error("Derni√®re vid√©o introuvable.");

      const vUrl =
        `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,snippet&id=${ids.join(",")}&key=${apiKey}`;
      const vData = await fetchJson(vUrl);

      for(const v of (vData.items || [])){
        const id = v?.id;
        const iso = v?.contentDetails?.duration;
        if(!id || !iso) continue;

        const sec = isoDurationToSeconds(iso);
        if(sec < MIN_SECONDS) continue; // ‚úÖ pas de short

        const sn = v?.snippet || {};
        const thumbs = sn?.thumbnails || {};

        const thumb =
          thumbs?.maxres?.url ||
          thumbs?.standard?.url ||
          thumbs?.high?.url ||
          thumbs?.medium?.url ||
          thumbs?.default?.url ||
          "";

        const title = (sn?.title || "").trim();
        const obj = { videoId: id, title: title || "(Sans titre)", thumb };

        saveLatest(channelId, obj);
        return obj;
      }

      throw new Error("Aucune vid√©o non-short trouv√©e parmi les derniers uploads.");
    }

    async function ensureLatest(channelId){
      const cached = loadLatest(channelId);
      if(cached) return cached;
      return await fetchLatestVideo(channelId);
    }

    function uniqueLatestChannelIds(){
      const set = new Set();
      for(const e of ENTRIES) set.add(e.avatarChannelId);
      return Array.from(set);
    }

    /* ========= ACCORDEON UI ========= */
    const channelsListEl = document.getElementById("channels-list");
    const favoritesListEl = document.getElementById("favorites-list");
    const favoritesEmptyEl = document.getElementById("favorites-empty");

    function setExpandHeight(card, expandEl){
      if(!card.classList.contains("open")){
        expandEl.style.maxHeight = "0px";
        return;
      }
      expandEl.style.maxHeight = expandEl.scrollHeight + "px";
    }

    async function fillLatestUI(entry, expandInner, card, expand){
      const channelId = entry.avatarChannelId;
      expandInner.innerHTML = `<div class="latest-loading">Chargement de la derni√®re vid√©o‚Ä¶</div>`;

      try{
        const latest = await ensureLatest(channelId);
        const openLatest = (e)=>{
          e.stopPropagation();
          openYouTubePreferApp(latest.videoId);
        };

        const wrap = document.createElement("div");

        // Derni√®re vid√©o
        const t = document.createElement("div");
        t.className = "latest-title";
        t.textContent = "Derni√®re vid√©o en ligne";
        wrap.appendChild(t);

        const row = document.createElement("div");
        row.className = "latest-row";

        const img = document.createElement("img");
        img.className = "latest-thumb";
        img.alt = "Miniature derni√®re vid√©o";
        if(latest.thumb) img.src = latest.thumb;
        img.addEventListener("click", openLatest);

        const meta = document.createElement("div");
        meta.className = "latest-meta";

        const title = document.createElement("div");
        title.className = "latest-video-title";
        title.textContent = latest.title || "(Sans titre)";
        title.addEventListener("click", openLatest);

        const hint = document.createElement("div");
        hint.className = "latest-hint";
        hint.textContent = "Clique sur la miniature ou le titre pour ouvrir la vid√©o.";

        meta.appendChild(title);
        meta.appendChild(hint);

        row.appendChild(img);
        row.appendChild(meta);
        wrap.appendChild(row);

        // Random
        const rt = document.createElement("div");
        rt.className = "random-title";
        rt.textContent = "Vid√©o al√©atoire";
        wrap.appendChild(rt);

        const rrow = document.createElement("div");
        rrow.className = "random-row";

        const rthumb = document.createElement("div");
        rthumb.className = "random-thumb";
        rthumb.title = "Lancer une vid√©o random";

        const rmeta = document.createElement("div");
        rmeta.className = "random-meta";

        const raction = document.createElement("div");
        raction.className = "random-action";
        raction.textContent = "Lance une vid√©o random";

        const rhint = document.createElement("div");
        rhint.className = "random-hint";
        rhint.textContent = "Tu ne sais pas sur quoi tu vas tomber üòÑ";

        const doRandom = (e)=>{
          e.stopPropagation();
          launchEntry(entry);
        };

        rthumb.addEventListener("click", doRandom);
        raction.addEventListener("click", doRandom);

        rmeta.appendChild(raction);
        rmeta.appendChild(rhint);

        rrow.appendChild(rthumb);
        rrow.appendChild(rmeta);

        wrap.appendChild(rrow);

        expandInner.innerHTML = "";
        expandInner.appendChild(wrap);

        // recalcul hauteur
        setExpandHeight(card, expand);

      }catch(err){
        expandInner.innerHTML = `<div class="latest-error">Impossible de charger la derni√®re vid√©o (API / quota / r√©seau).</div>`;
        setExpandHeight(card, expand);
      }
    }

    function closeAllAccordions(container){
      container.querySelectorAll(".channel-item.open").forEach(card=>{
        card.classList.remove("open");
        const expand = card.querySelector(".channel-expand");
        if(expand) expand.style.maxHeight = "0px";
      });
    }

    function toggleAccordion(card){
      const expand = card.querySelector(".channel-expand");
      const expandInner = card.querySelector(".expand-inner");
      const entry = card._entry;

      const willOpen = !card.classList.contains("open");

      // close others in same list (plus propre)
      const container = card.parentElement;
      closeAllAccordions(container);

      card.classList.toggle("open", willOpen);

      if(willOpen){
        if(!expandInner.dataset.filled){
          fillLatestUI(entry, expandInner, card, expand);
          expandInner.dataset.filled = "1";
        }
      }

      setExpandHeight(card, expand);
    }

    function makeEntryCard(entry){
      const card = document.createElement("div");
      card.className = "channel-item";
      card._entry = entry;

      const main = document.createElement("div");
      main.className = "channel-main";

      const left = document.createElement("div");
      left.className = "channel-left";

      const img = document.createElement("img");
      img.className = "channel-avatar hidden";
      img.alt = entry.title;

      const fallback = document.createElement("div");
      fallback.className = "channel-fallback";
      fallback.textContent = (entry.title || "X")[0].toUpperCase();

      const text = document.createElement("div");
      text.className = "channel-text";

      const name = document.createElement("div");
      name.className = "channel-name";
      name.textContent = entry.title;

      const sub = document.createElement("div");
      sub.className = "channel-sub";
      sub.textContent = `${entry.subtitlePrefix} / ${statsLineForEntry(entry)}`;

      text.appendChild(name);
      text.appendChild(sub);

      left.appendChild(img);
      left.appendChild(fallback);
      left.appendChild(text);

      const right = document.createElement("div");
      right.className = "channel-right";

      const starBtn = document.createElement("div");
      starBtn.className = "star-btn";
      starBtn.title = "Ajouter aux favoris";

      const star = document.createElement("div");
      star.className = "star" + (isFav(entry.entryId) ? " fav" : "");
      star.textContent = "‚òÖ";
      starBtn.appendChild(star);

      starBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const on = toggleFav(entry.entryId);
        star.classList.toggle("fav", on);
        renderFavorites();
      });

      const chevBtn = document.createElement("div");
      chevBtn.className = "chev-btn";
      chevBtn.title = "Ouvrir";
      chevBtn.textContent = "‚Ä∫";

      right.appendChild(starBtn);
      right.appendChild(chevBtn);

      main.appendChild(left);
      main.appendChild(right);

      const expand = document.createElement("div");
      expand.className = "channel-expand";

      const expandInner = document.createElement("div");
      expandInner.className = "expand-inner";
      expand.appendChild(expandInner);

      card.appendChild(main);
      card.appendChild(expand);

      // ‚úÖ clic carte = ouvrir/fermer (plus de random direct)
      card.addEventListener("click", ()=> toggleAccordion(card));

      // clic chevron = pareil
      chevBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        toggleAccordion(card);
      });

      (async ()=>{
        try{
          const url = await ensureAvatarFor(entry.avatarChannelId);
          if(url){
            img.src = url;
            img.classList.remove("hidden");
            fallback.classList.add("hidden");
          }
        }catch{}
      })();

      return card;
    }

    function renderChannels(){
      channelsListEl.innerHTML = "";
      for(const entry of ENTRIES){
        channelsListEl.appendChild(makeEntryCard(entry));
      }
    }

    function renderFavorites(){
      const favs = loadFavorites();
      favoritesListEl.innerHTML = "";

      const items = ENTRIES.filter(e => favs.includes(e.entryId));

      if(items.length === 0){
        favoritesEmptyEl.classList.remove("hidden");
        return;
      }

      favoritesEmptyEl.classList.add("hidden");
      for(const entry of items){
        favoritesListEl.appendChild(makeEntryCard(entry));
      }
    }

    /* ========= MODAL HISTORIQUE ========= */
    const modal = document.getElementById("history-modal");
    const historyBtn = document.getElementById("history-btn");
    const closeBtn = document.getElementById("history-close");
    const historyClearBtn = document.getElementById("history-clear");
    const copyAllBtn = document.getElementById("history-copy-all");
    const historyListEl = document.getElementById("history-list");
    const historyCountEl = document.getElementById("history-count");

    function openHistory(){
      historyListEl.innerHTML = "";
      let total = 0;

      for(const ch of CHANNELS_ALL){
        const cached = loadCache(ch);
        const metaMap = cached?.metaMap || {};
        const seenList = loadSeenList(ch).slice().reverse();
        total += seenList.length;

        const header = document.createElement("div");
        header.style.color = "rgba(255,255,255,0.9)";
        header.style.fontWeight = "900";
        header.style.margin = "12px 0 8px 0";
        header.textContent = `${ch.name} ‚Äî ${seenList.length} vid√©o(s)`;
        historyListEl.appendChild(header);

        if(seenList.length === 0){
          const empty = document.createElement("div");
          empty.style.color = "rgba(255,255,255,0.65)";
          empty.style.marginBottom = "8px";
          empty.textContent = "Aucune vid√©o pour l‚Äôinstant.";
          historyListEl.appendChild(empty);
          continue;
        }

        for(const id of seenList){
          const url = `https://www.youtube.com/watch?v=${id}`;
          const meta = metaMap[id] || ["(titre indisponible ‚Äî rebuild conseill√©)", ""];
          const title = meta[0] || "(sans titre)";
          const thumb = meta[1] || "";

          const row = document.createElement("div");
          row.className = "history-item";

          const img = document.createElement("img");
          img.className = "thumb";
          img.alt = "Miniature";
          img.loading = "lazy";
          if(thumb) img.src = thumb;

          const left = document.createElement("div");
          left.className = "history-left";

          const titleEl = document.createElement("div");
          titleEl.className = "history-title";
          titleEl.textContent = title;

          const idEl = document.createElement("div");
          idEl.className = "history-id";
          idEl.textContent = id;

          const link = document.createElement("a");
          link.className = "history-link";
          link.href = url;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = url;

          left.appendChild(titleEl);
          left.appendChild(idEl);
          left.appendChild(link);

          const copyBtn = document.createElement("button");
          copyBtn.className = "small-btn";
          copyBtn.textContent = "Copier";
          copyBtn.addEventListener("click", async () => {
            try{
              await navigator.clipboard.writeText(url);
              copyBtn.textContent = "Copi√© ‚úÖ";
              setTimeout(()=>copyBtn.textContent="Copier", 900);
            }catch{
              alert("Impossible de copier (autorisation navigateur).");
            }
          });

          row.appendChild(img);
          row.appendChild(left);
          row.appendChild(copyBtn);
          historyListEl.appendChild(row);
        }
      }

      historyCountEl.textContent = `Total vid√©os d√©j√† sorties : ${total}`;
      modal.classList.remove("hidden");
    }

    function closeHistory(){ modal.classList.add("hidden"); }

    historyBtn.addEventListener("click", openHistory);
    closeBtn.addEventListener("click", closeHistory);
    modal.addEventListener("click", (e)=>{ if(e.target === modal) closeHistory(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && !modal.classList.contains("hidden")) closeHistory(); });

    historyClearBtn.addEventListener("click", ()=>{
      resetSeenAll();
      openHistory();
      renderChannels();
      renderFavorites();
      toast("Historique vid√© ‚úÖ");
    });

    copyAllBtn.addEventListener("click", async ()=>{
      const lines = [];
      for(const ch of CHANNELS_ALL){
        const seenList = loadSeenList(ch).slice().reverse();
        if(seenList.length){
          lines.push(`=== ${ch.name} ===`);
          for(const id of seenList) lines.push(`https://www.youtube.com/watch?v=${id}`);
          lines.push("");
        }
      }
      try{
        await navigator.clipboard.writeText(lines.join("\n"));
        toast("Historique copi√© ‚úÖ");
      }catch{
        alert("Impossible de copier (autorisation navigateur).");
      }
    });

    /* ========= ACTIONS ========= */
    const rebuildAllBtn = document.getElementById("rebuild-all-btn");
    const rebuildLatestBtn = document.getElementById("rebuild-latest-btn");
    const resetSeenBtn = document.getElementById("reset-seen-btn");

    rebuildAllBtn.addEventListener("click", async ()=>{
      try{
        for(const ch of CHANNELS_ALL){
          toast(`Rebuild‚Ä¶ ${ch.name}`);
          await buildPoolForChannel(ch, true);
        }
        toast("‚úÖ Rebuild termin√©.");
        renderChannels();
        renderFavorites();
      }catch(e){
        console.error(e);
        toast("Erreur : " + (e.message || e));
      }
    });

    rebuildLatestBtn.addEventListener("click", async ()=>{
      try{
        const ids = uniqueLatestChannelIds();
        for(const id of ids) clearLatest(id);
        for(const id of ids){
          toast("Derni√®re vid√©o‚Ä¶");
          await fetchLatestVideo(id);
        }
        toast("‚úÖ Derni√®res vid√©os mises √† jour.");
        renderChannels();
        renderFavorites();
      }catch(e){
        console.error(e);
        toast("Erreur : " + (e.message || e));
      }
    });

    resetSeenBtn.addEventListener("click", ()=>{
      resetSeenAll();
      toast("Historique r√©initialis√© ‚úÖ");
      renderChannels();
      renderFavorites();
    });

    /* ========= BOOT ========= */
    (function boot(){
      renderChannels();
      renderFavorites();
    })();
  </script>
</body>
</html>
