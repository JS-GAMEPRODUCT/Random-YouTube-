<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>YouTube Random Video — V0.1</title>

  <style>
    :root{
      --bg1:#3a0f12; --bg2:#1b0709; --bg3:#0e0405;
      --stroke: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --shadow: 0 18px 55px rgba(0,0,0,0.45);
      --accent:#ff2e2e;
      --gold:#ffd24a;
      color-scheme: dark;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, var(--bg1) 0%, var(--bg2) 45%, var(--bg3) 100%);
      overflow:hidden;
    }

    .bg-glow{
      position:fixed; inset:-25%;
      background:
        radial-gradient(circle at 18% 18%, rgba(255,46,46,0.22), transparent 56%),
        radial-gradient(circle at 80% 30%, rgba(255,255,255,0.10), transparent 55%),
        radial-gradient(circle at 65% 80%, rgba(255,46,46,0.12), transparent 58%),
        radial-gradient(circle at 25% 85%, rgba(255,255,255,0.06), transparent 55%);
      filter: blur(10px);
      pointer-events:none;
      z-index:0;
    }

    /* ===== TOP BAR ===== */
    .topbar{
      position:fixed;
      top: calc(10px + env(safe-area-inset-top));
      left: 50%;
      transform: translateX(-50%);
      width: min(720px, 94vw);
      z-index:50;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      box-shadow: 0 18px 55px rgba(0,0,0,0.35);
      padding: 12px 14px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand-mark{
      width:44px; height:44px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), transparent 55%),
                  linear-gradient(180deg, rgba(255,46,46,0.38), rgba(0,0,0,0.10));
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 12px 26px rgba(0,0,0,0.35);
      flex:0 0 auto;
    }
    .brand-mark svg{ width:22px; height:22px; fill:#fff; opacity:.95; }
    .brand-text{ min-width:0; }
    .brand-title{
      font-family: "Arial Black", Impact, sans-serif;
      letter-spacing: .6px;
      font-size: 18px;
      line-height: 1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand-title .yt{ color:#fff; text-shadow:0 0 10px rgba(255,255,255,0.12); }
    .brand-title .sep{
      display:inline-block; width:6px; height:16px; margin:0 6px -2px 6px;
      background: linear-gradient(#ff3b3b,#b31217);
      border-radius: 3px;
    }
    .brand-title .rd{ color: var(--accent); text-shadow:0 0 14px rgba(255,0,0,0.38); }
    .brand-title .vd{ color: rgba(255,255,255,0.92); text-shadow:0 0 10px rgba(255,255,255,0.10); }
    .brand-sub{
      margin-top:2px;
      font-size: 12px;
      color: rgba(255,255,255,0.66);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand-chip{
      flex:0 0 auto;
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      color: rgba(255,255,255,0.80);
      font-size: 12px;
      font-weight: 900;
      user-select:none;
    }
    .brand-chip .dot{
      width:8px; height:8px; border-radius:50%;
      background: rgba(255,46,46,0.9);
      box-shadow: 0 0 14px rgba(255,46,46,0.45);
    }

    /* App layout */
    .app{
      position:relative; z-index:1;
      width:100%; height:100vh;
      display:flex; align-items:flex-start; justify-content:center;
      padding: calc(92px + env(safe-area-inset-top)) 16px 24px 16px;
      overflow:hidden;
    }

    .page{
      width:min(720px, 94vw);
      max-height: calc(100vh - 130px - env(safe-area-inset-top));
      display:none;
      animation: fadeIn 180ms ease both;
    }
    .page.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }

    .page-top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin: 6px 4px 12px 4px;
    }
    .back-btn{
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer; border:none;
      background:rgba(0,0,0,0.20);
      color:#fff; font-weight:950;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      transition: filter .12s ease, transform .12s ease;
    }
    .back-btn:hover{ filter:brightness(1.10); }
    .back-btn:active{ transform:translateY(1px); }

    .page-title{
      font-family:"Arial Black",Impact,sans-serif;
      letter-spacing:.5px; font-size:16px; opacity:0.95;
    }

    .menu-card{
      border-radius:24px;
      border:1px solid rgba(255,255,255,0.13);
      background: rgba(255,255,255,0.07);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:16px;
      overflow:hidden;
    }

    .home-hero{ padding: 12px 4px 14px 4px; }
    .home-hero h1{ margin:0; font-size: 20px; letter-spacing: .2px; font-weight: 950; }
    .home-hero p{ margin: 6px 0 0 0; font-size: 13px; color: rgba(255,255,255,0.70); line-height: 1.35; }

    .menu-list{ display:flex; flex-direction:column; gap:10px; }

    .menu-item{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
    }
    .menu-item:hover{ filter:brightness(1.08); }
    .menu-item:active{ transform:translateY(1px); }

    .menu-left{ display:flex; align-items:center; gap:12px; min-width:0; }

    .icon{
      width:44px; height:44px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 22px rgba(0,0,0,0.28);
      flex:0 0 auto;
    }
    .icon svg{ width:22px; height:22px; fill: rgba(255,255,255,0.92); }

    .menu-item[data-go="page-channels"] .icon{ outline: 2px solid rgba(255,46,46,0.35); }
    .menu-item[data-go="page-favs"] .icon{ outline: 2px solid rgba(255,210,74,0.35); }
    .menu-item[data-go="page-help"] .icon{ outline: 2px solid rgba(93,167,255,0.28); }
    .menu-item[data-go="page-history"] .icon{ outline: 2px solid rgba(255,255,255,0.18); }
    .menu-item[data-go="page-options"] .icon{ outline: 2px solid rgba(140,255,190,0.20); }

    .menu-text{ min-width:0; }
    .menu-text .t1{
      font-size:16px; font-weight:950; color:rgba(255,255,255,0.93);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .menu-text .t2{
      margin-top:2px; font-size:12.5px; color:rgba(255,255,255,0.62);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .chev{
      width:32px; height:32px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      flex:0 0 auto;
    }
    .chev svg{ width:16px; height:16px; fill: rgba(255,255,255,0.72); }

    .footer{
      margin-top:12px;
      text-align:center;
      color:rgba(255,255,255,0.55);
      font-size:12px;
    }
    .hidden{ display:none !important; }

    .scroll{
      max-height:60vh;
      overflow:auto;
      padding-right:4px;
      padding-bottom:105px;
      overscroll-behavior: contain;
    }
    .scroll::-webkit-scrollbar{ width:10px; }
    .scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.16);
      border-radius:10px;
      border:2px solid rgba(0,0,0,0.15);
    }

    /* ✅ TOOLBAR CHAÎNES (recherche + tri) */
    .channels-toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin: 0 0 12px 0;
    }
    .search{
      flex: 1 1 260px;
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
    }
    .search svg{ width:18px; height:18px; fill: rgba(255,255,255,0.72); flex:0 0 auto; }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:#fff;
      font-weight:900;
      font-size:14px;
    }
    .search input::placeholder{ color: rgba(255,255,255,0.45); font-weight:800; }

    .sort{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color:#fff;
      font-weight:950;
      outline:none;
      cursor:pointer;
    }

    /* =========================
       ✅ CHANNEL CARD + ACCORDION
       ========================= */
    .channel-item{
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
      margin-bottom:12px;
      overflow:hidden;
    }
    .channel-item:hover{ filter:brightness(1.08); }
    .channel-item:active{ transform:translateY(1px); }

    .channel-main{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 14px;
    }

    .channel-left{ display:flex; align-items:center; gap:14px; min-width:0; flex:1 1 auto; }

    .channel-avatar{
      width:52px; height:52px; border-radius:50%;
      object-fit:cover;
      border:2px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      flex:0 0 auto;
    }

    .channel-fallback{
      width:52px; height:52px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-family:"Arial Black",Impact,sans-serif; font-size:18px; color:#fff;
      background: linear-gradient(#c4161c,#9e1216);
      border:2px solid #7a0e12;
      box-shadow: 0 10px 18px rgba(0,0,0,0.35);
      text-shadow: 1px 1px 0 #5a0b0e;
      flex:0 0 auto;
    }

    .channel-text{ min-width:0; flex:1 1 auto; }
    .channel-name{
      font-size:18px; font-weight:900; color:#fff; letter-spacing:.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .channel-sub{
      font-size:12px; color:rgba(255,255,255,0.70); margin-top:4px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .channel-right{ display:flex; align-items:center; gap:10px; flex:0 0 auto; }

    .star-btn, .chev-btn{
      width:34px; height:34px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
      user-select:none;
      flex:0 0 auto;
    }
    .star-btn:hover, .chev-btn:hover{ filter:brightness(1.08); }
    .star-btn:active, .chev-btn:active{ transform:translateY(1px); }

    .star{ font-size:18px; line-height:1; color: rgba(255,255,255,0.55); }
    .star.fav{ color: var(--gold); text-shadow: 0 0 10px rgba(255,210,74,0.35); }

    .chev-btn svg{ width:16px; height:16px; fill: rgba(255,255,255,0.72); transition: transform .18s ease; }
    .channel-item.open .chev-btn svg{ transform: rotate(90deg); }

    .channel-expand{
      max-height:0;
      overflow:hidden;
      transition: max-height .22s ease;
      border-top: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.12);
    }
    .expand-inner{ padding:12px 14px 14px 14px; }

    .latest-title, .random-title{
      font-weight:900;
      color:rgba(255,255,255,0.90);
      font-size:13px;
      margin-bottom:10px;
    }
    .random-title{ margin:14px 0 10px 0; }

    .latest-row, .random-row{ display:flex; gap:12px; align-items:flex-start; }

    .latest-thumb{
      width:160px; height:90px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      object-fit:cover;
      background: rgba(255,255,255,0.06);
      cursor:pointer;
      flex:0 0 auto;
      transition: filter .12s ease, transform .12s ease;
    }
    .latest-thumb:hover{ filter:brightness(1.06); }
    .latest-thumb:active{ transform:translateY(1px); }

    .latest-meta, .random-meta{ min-width:0; }

    .latest-video-title{
      font-weight:900;
      font-size:14px;
      color:rgba(255,255,255,0.92);
      line-height:1.25;
      cursor:pointer;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
      transition: filter .12s ease;
    }
    .latest-video-title:hover{ filter:brightness(1.08); }

    .latest-hint, .random-hint, .random-stats{
      margin-top:6px;
      font-size:12px;
      color:rgba(255,255,255,0.60);
    }
    .random-stats{
      margin-top:6px;
      color:rgba(255,255,255,0.68);
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .latest-loading{ font-size:12px; color:rgba(255,255,255,0.65); padding:10px 0; }
    .latest-error{ font-size:12px; color:rgba(255,120,120,0.95); padding:10px 0; font-weight:800; }

    .random-thumb{
      position:relative;
      overflow:hidden;
      width:160px; height:90px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.14), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.32));
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex:0 0 auto;
      transition: filter .12s ease, transform .12s ease;
    }
    .random-thumb::before{
      position:relative;
      z-index:2;
      content:"?";
      font-family:"Arial Black",Impact,sans-serif;
      font-size:46px;
      color:rgba(255,255,255,0.85);
      text-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    .random-thumb:hover{ filter:brightness(1.06); }
    .random-thumb:active{ transform:translateY(1px); }

    .mystery-img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      filter: blur(6px) saturate(1.00) brightness(0.92);
      transform: scale(1.10);
      opacity:0.92;
      z-index:1;
      pointer-events:none;
    }
    .random-thumb::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,0.00), rgba(0,0,0,0.20));
      z-index:1;
      pointer-events:none;
    }

    .random-action{
      font-weight:900;
      font-size:14px;
      color:rgba(255,255,255,0.92);
      line-height:1.25;
      cursor:pointer;
      transition: filter .12s ease;
    }
    .random-action:hover{ filter:brightness(1.08); }

    .row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; justify-content:center; }
    .small-btn{
      font-weight:900; font-size:14px;
      padding:10px 14px; border-radius:14px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(0,0,0,0.22); color:#fff;
      cursor:pointer; transition:filter .12s ease, transform .12s ease;
    }
    .small-btn:hover{ filter:brightness(1.10); }
    .small-btn:active{ transform:translateY(1px); }

    /* ===== HISTORIQUE ===== */
    .seg-wrap{ display:flex; gap:10px; margin:8px 0 12px 0; flex-wrap:wrap; }
    .seg-btn{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color:#fff;
      font-weight:950;
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
      user-select:none;
    }
    .seg-btn:hover{ filter:brightness(1.08); }
    .seg-btn:active{ transform:translateY(1px); }
    .seg-btn.active{
      border-color: rgba(255,46,46,0.35);
      box-shadow: 0 0 0 2px rgba(255,46,46,0.12) inset;
    }

    .select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color:#fff;
      font-weight:900;
      outline:none;
    }

    .history-topline{ margin-top:6px; color:rgba(255,255,255,0.70); font-size:13px; line-height:1.35; }

    .history-list{
      margin-top:12px;
      overflow:auto;
      max-height:56vh;
      padding-right:4px;
      overscroll-behavior: contain;
    }
    .history-list::-webkit-scrollbar{ width:10px; }
    .history-list::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.16);
      border-radius:10px;
      border:2px solid rgba(0,0,0,0.15);
    }

    .history-item{
      display:grid;
      grid-template-columns:120px 1fr auto;
      gap:10px; align-items:center;
      padding:10px; border-radius:14px; margin-bottom:10px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
    }
    .thumb{
      width:120px; height:90px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      object-fit:cover; background:rgba(255,255,255,0.05);
    }
    .history-left{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .history-title{ color:rgba(255,255,255,0.95); font-weight:900; font-size:14px; line-height:1.2; }
    .history-id{ font-family:monospace; color:rgba(255,255,255,0.80); font-size:12px; }
    .history-link{ color:#ff4d4d; text-decoration:none; word-break:break-all; font-size:13px; }
    .history-link:hover{ text-decoration:underline; }

    /* Toast */
    .toast-wrap{
      position:fixed; left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      z-index:10000; display:flex; flex-direction:column; gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      min-width: min(520px, 92vw);
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(15,5,6,0.88);
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color:rgba(255,255,255,0.90);
      font-weight:950;
      text-align:center;
      animation: toastIn 180ms ease both;
    }
    @keyframes toastIn{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }

    /* ✅ OVERLAY (rebuild / tri abonnés) */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      z-index:9999;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .overlay.show{ display:flex; }
    .overlay-card{
      width: min(520px, 92vw);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(15,5,6,0.92);
      box-shadow: 0 22px 60px rgba(0,0,0,0.55);
      padding: 16px;
      text-align:center;
    }
    .overlay-title{ font-weight:950; font-size:16px; margin: 2px 0 8px 0; }
    .overlay-sub{ color: rgba(255,255,255,0.70); font-size: 13px; line-height:1.4; margin: 0 0 12px 0; }
    .spinner{
      width:44px; height:44px;
      margin: 8px auto 10px auto;
      border-radius:50%;
      border:4px solid rgba(255,255,255,0.18);
      border-top-color: rgba(255,46,46,0.90);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ✅ MODAL PLAYER (YouTube IFrame API) */
    .player-modal{
      position:fixed;
      inset:0;
      z-index:12000;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,0.62);
    }
    .player-modal.show{ display:flex; }

    .player-card{
      width: min(860px, 96vw);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(15,5,6,0.92);
      box-shadow: 0 22px 70px rgba(0,0,0,0.65);
      overflow:hidden;
    }
    .player-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 12px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
    }
    .player-title{
      font-weight:950;
      font-size: 13px;
      color: rgba(255,255,255,0.86);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .player-actions{ display:flex; gap:10px; }
    .player-btn{
      font-weight:950;
      font-size:13px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      color:#fff;
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
      user-select:none;
    }
    .player-btn:hover{ filter:brightness(1.08); }
    .player-btn:active{ transform: translateY(1px); }

    .player-body{ padding: 12px; }
    .player-frame{
      width:100%;
      aspect-ratio: 16 / 9;
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
    }
    #yt-player{ width:100%; height:100%; }
    .player-foot{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding: 10px 12px 12px 12px;
      color: rgba(255,255,255,0.70);
      font-size:12px;
    }

    /* ✅ OPTIONS UI (switch) */
    .opt-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
    }
    .opt-left{ min-width:0; }
    .opt-title{ font-weight:950; font-size:14px; }
    .opt-desc{
      margin-top:4px;
      font-size:12px;
      color: rgba(255,255,255,0.68);
      line-height:1.35;
    }
    .switch{
      width: 52px;
      height: 30px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      position:relative;
      cursor:pointer;
      flex:0 0 auto;
      transition: filter .12s ease, opacity .12s ease;
      user-select:none;
    }
    .switch:hover{ filter:brightness(1.08); }
    .switch::after{
      content:"";
      position:absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.85);
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
      transition: transform .16s ease;
    }
    .switch.on{
      background: rgba(255,46,46,0.28);
      border-color: rgba(255,46,46,0.35);
      box-shadow: 0 0 0 2px rgba(255,46,46,0.10) inset;
    }
    .switch.on::after{
      transform: translateX(22px);
      background: rgba(255,255,255,0.92);
    }
    /* ✅ nouveau : switch désactivé en mode local file:// */
    .switch.disabled{
      opacity: .45;
      pointer-events: none;
      filter: none !important;
    }

    @media (max-width:768px){
      .topbar{ top: calc(8px + env(safe-area-inset-top)); }
      .brand-mark{ width:42px; height:42px; }
      .brand-title{ font-size:17px; }
      .app{ padding-top: calc(90px + env(safe-area-inset-top)); }
      .scroll{ max-height:58vh; padding-bottom:115px; }
      .latest-thumb, .random-thumb{ width:140px; height:78px; }
      .history-item{ grid-template-columns:96px 1fr; grid-template-rows:auto auto; }
      .thumb{ width:96px; height:72px; }
      .history-item .small-btn{ grid-column:1 / -1; justify-self:end; }
      .history-list{ max-height:60vh; }
      .player-card{ width: min(760px, 96vw); }
    }

    /* ✅ iOS STABLE */
    @supports (-webkit-touch-callout: none) {
      .topbar, .menu-card, .menu-item, .channel-item, .toast, .player-card{
        -webkit-backdrop-filter: none !important;
        backdrop-filter: none !important;
      }
      .topbar{ background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08)) !important; }
      .menu-card{
        background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08)) !important;
        box-shadow: 0 18px 55px rgba(0,0,0,0.35) !important;
      }
      .menu-item{ background: rgba(255,255,255,0.14) !important; }
      .channel-item{ background: rgba(255,255,255,0.12) !important; }
      .toast{ background: rgba(15,5,6,0.92) !important; }
      .history-item{ background: rgba(255,255,255,0.10) !important; }
      .player-card{ background: rgba(15,5,6,0.95) !important; }
    }
  </style>
</head>

<body>
  <div class="bg-glow"></div>

  <header class="topbar" aria-label="YouTube Random Video">
    <div class="brand">
      <div class="brand-left">
        <div class="brand-mark" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M8 5.5v13l11-6.5L8 5.5z"></path>
          </svg>
        </div>
        <div class="brand-text">
          <div class="brand-title">
            <span class="yt">YouTube</span><span class="sep"></span><span class="rd">Random</span> <span class="vd">Video</span>
          </div>
          <div class="brand-sub">Choisis une chaîne, puis lance une vidéo au hasard</div>
        </div>
      </div>
      <div class="brand-chip" title="Version">
        <span class="dot"></span>
        <span>V 0.1</span>
      </div>
    </div>
  </header>

  <div class="app">
    <section id="page-home" class="page active">
      <div class="menu-card">
        <div class="home-hero">
          <h1>Menu</h1>
          <p>Interface pensée comme une appli. Dans <b>Chaînes</b> : dernière vidéo + random (sans shorts).</p>
        </div>

        <div class="menu-list">

          <div class="menu-item" data-go="page-channels" role="button" aria-label="Aller vers Chaînes">
            <div class="menu-left">
              <div class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M16 11c1.66 0 3-1.57 3-3.5S17.66 4 16 4s-3 1.57-3 3.5S14.34 11 16 11zm-8 0c1.66 0 3-1.57 3-3.5S9.66 4 8 4 5 5.57 5 7.5 6.34 11 8 11zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.95 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
              </div>
              <div class="menu-text">
                <div class="t1">Chaînes</div>
                <div class="t2">Sélectionner un youtubeur</div>
              </div>
            </div>
            <div class="chev" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6z"></path></svg>
            </div>
          </div>

          <div class="menu-item" data-go="page-favs" role="button" aria-label="Aller vers Favoris">
            <div class="menu-left">
              <div class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
              </div>
              <div class="menu-text">
                <div class="t1">Favoris</div>
                <div class="t2">Tes chaînes favorites</div>
              </div>
            </div>
            <div class="chev" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6z"></path></svg>
            </div>
          </div>

          <div class="menu-item" data-go="page-history" role="button" aria-label="Aller vers Historique">
            <div class="menu-left">
              <div class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M13 3a9 9 0 1 0 8.95 10h-2.02A7 7 0 1 1 13 5V2l4 4-4 4V7a5 5 0 1 0 5 6h2a7 7 0 1 1-7-10z"/>
                </svg>
              </div>
              <div class="menu-text">
                <div class="t1">Historique</div>
                <div class="t2">Global ou par chaîne</div>
              </div>
            </div>
            <div class="chev" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6z"></path></svg>
            </div>
          </div>

          <div class="menu-item" data-go="page-options" role="button" aria-label="Aller vers Options">
            <div class="menu-left">
              <div class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.63l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.28,7.28,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,13.79,2H10.21a.5.5,0,0,0-.49.42L9.34,5.07a7.28,7.28,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.63L4.86,11.06a7.43,7.43,0,0,0-.05.94,7.43,7.43,0,0,0,.05.94L2.75,14.59a.5.5,0,0,0-.12.63l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.28,7.28,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.42h3.58a.5.5,0,0,0,.49-.42l.38-2.65a7.28,7.28,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.63ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
                </svg>
              </div>
              <div class="menu-text">
                <div class="t1">Options</div>
                <div class="t2">Lecteur intégré, etc.</div>
              </div>
            </div>
            <div class="chev" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6z"></path></svg>
            </div>
          </div>

          <div class="menu-item" data-go="page-help" role="button" aria-label="Aller vers Comment ça marche ?">
            <div class="menu-left">
              <div class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/>
                </svg>
              </div>
              <div class="menu-text">
                <div class="t1">Comment ça marche ?</div>
                <div class="t2">Explication rapide</div>
              </div>
            </div>
            <div class="chev" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6z"></path></svg>
            </div>
          </div>

        </div>

        <div class="footer">YouTube Random Video — Menu</div>
      </div>
    </section>

    <!-- PAGE CHAÎNES -->
    <section id="page-channels" class="page">
      <div class="page-top">
        <button class="back-btn" data-back="page-home">← Retour</button>
        <div class="page-title">Chaînes</div>
        <div style="width:92px;"></div>
      </div>

      <div class="menu-card">
        <div class="channels-toolbar">
          <div class="search" title="Rechercher une chaîne">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 14 15.5l.27.28v.79l5 5L20.5 19l-5-5zM10 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>
            <input id="channels-search" type="text" placeholder="Rechercher une chaîne…" />
          </div>

          <select id="channels-sort" class="sort" title="Trier">
            <option value="default">Tri : Par défaut</option>
            <option value="az">Tri : A → Z</option>
            <option value="za">Tri : Z → A</option>
            <option value="subs_desc">Tri : Abonnés (↓)</option>
          </select>
        </div>

        <div id="channels-list" class="scroll"></div>

        <div class="row">
          <button id="rebuild-all-btn" class="small-btn">Rebuild caches</button>
          <button id="rebuild-latest-btn" class="small-btn">Rebuild dernières vidéos</button>
        </div>
      </div>
    </section>

    <!-- PAGE FAVORIS -->
    <section id="page-favs" class="page">
      <div class="page-top">
        <button class="back-btn" data-back="page-home">← Retour</button>
        <div class="page-title">Favoris</div>
        <div style="width:92px;"></div>
      </div>

      <div class="menu-card">
        <div id="favorites-list" class="scroll"></div>
        <div id="favorites-empty" class="footer hidden">Aucun favori pour l’instant.</div>
      </div>
    </section>

    <!-- PAGE HISTORIQUE -->
    <section id="page-history" class="page">
      <div class="page-top">
        <button class="back-btn" data-back="page-home">← Retour</button>
        <div class="page-title">Historique</div>
        <div style="width:92px;"></div>
      </div>

      <div class="menu-card">
        <div class="home-hero" style="padding-top:6px;">
          <h1 style="font-size:18px;">Historique</h1>
          <p style="margin-top:6px;">Choisis <b>Global</b> (ordre réel) ou <b>Par chaîne</b> (filtrer + supprimer une chaîne).</p>
        </div>

        <div class="seg-wrap">
          <button id="hist-mode-global" class="seg-btn active" type="button">Global</button>
          <button id="hist-mode-channel" class="seg-btn" type="button">Par chaîne</button>
        </div>

        <div id="hist-channel-picker" class="hidden">
          <select id="hist-channel-select" class="select"></select>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="hist-copy" class="small-btn">Copier</button>
          <button id="hist-clear" class="small-btn">Supprimer</button>
        </div>

        <div id="hist-topline" class="history-topline"></div>
        <div id="history-list" class="history-list"></div>

        <div class="footer">YouTube Random Video — Historique</div>
      </div>
    </section>

    <!-- PAGE OPTIONS -->
    <section id="page-options" class="page">
      <div class="page-top">
        <button class="back-btn" data-back="page-home">← Retour</button>
        <div class="page-title">Options</div>
        <div style="width:92px;"></div>
      </div>

      <div class="menu-card">
        <div class="home-hero" style="padding-top:6px;">
          <h1 style="font-size:18px;">Options</h1>
          <p style="margin-top:6px;">Personnalise l’expérience. Par défaut, le lecteur intégré est activé.</p>
        </div>

        <div class="opt-row">
          <div class="opt-left">
            <div class="opt-title">Lecteur intégré</div>
            <div class="opt-desc" id="opt-embed-desc">
              Si activé : la vidéo se lance dans l’appli (modal) + bouton “Prochaine random”.<br>
              Si désactivé : ouverture dans l’app YouTube / navigateur (comme avant).
            </div>
          </div>
          <div id="opt-embed-switch" class="switch" role="switch" aria-checked="true" tabindex="0" title="Activer/Désactiver"></div>
        </div>

        <div class="footer">YouTube Random Video — Options</div>
      </div>
    </section>

    <!-- PAGE HELP -->
    <section id="page-help" class="page">
      <div class="page-top">
        <button class="back-btn" data-back="page-home">← Retour</button>
        <div class="page-title">Comment ça marche ?</div>
        <div style="width:92px;"></div>
      </div>

      <div class="menu-card">
        <div style="color:rgba(255,255,255,0.74); font-size:13px; line-height:1.55;">
          • Va dans <b>“Chaînes”</b>.<br>
          • Clique sur une carte : ça ouvre le détail (dernier upload + random).<br>
          • Clique sur <b>“Lance une vidéo random”</b> dans le détail pour lancer une vidéo (sans shorts).<br>
          • <b>Fuze III</b> = tirage 50/50 entre Fuze III et Fiouse.<br>
          • L’étoile <b>★</b> ajoute/retire la chaîne des Favoris.<br>
          • <b>Rebuild caches</b> = rebuild pools random (48h).<br>
          • <b>Rebuild dernières vidéos</b> = force la MAJ des dernières vidéos (cache 6h).<br>
          • Sur téléphone : ouverture tente l’app YouTube, sinon navigateur.<br>
          • Option “Lecteur intégré” : lecture dans l’appli + “Prochaine random”.
        </div>
      </div>
    </section>

  </div><!-- /app -->

  <!-- TOAST -->
  <div id="toast-wrap" class="toast-wrap"></div>

  <!-- OVERLAY -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="overlay-card">
      <div class="spinner" aria-hidden="true"></div>
      <div id="overlay-title" class="overlay-title">Chargement…</div>
      <div id="overlay-sub" class="overlay-sub">Merci de patienter</div>
    </div>
  </div>

  <!-- MODAL PLAYER (IFrame API) -->
  <div id="player-modal" class="player-modal" aria-hidden="true">
    <div class="player-card" role="dialog" aria-modal="true" aria-label="Lecteur vidéo">
      <div class="player-head">
        <div id="player-title" class="player-title">Lecture…</div>
        <div class="player-actions">
          <button id="player-next" class="player-btn" type="button">⏭️ Prochaine random</button>
          <button id="player-open" class="player-btn" type="button">↗ Ouvrir YouTube</button>
          <button id="player-close" class="player-btn" type="button">✖ Fermer</button>
        </div>
      </div>

      <div class="player-body">
        <div class="player-frame">
          <div id="yt-player"></div>
        </div>
      </div>

      <div class="player-foot">
        <div id="player-foot-left">Lecteur intégré • IFrame API</div>
        <div id="player-foot-right"></div>
      </div>
    </div>
  </div>

  <script>
    /* =========================================================
       JS CLEAN — Fix local file:// + ouverture YouTube + preload API
       ========================================================= */

    const IS_FILE = (location.protocol === "file:");
    const IS_HTTPS = (location.protocol === "https:" || location.protocol === "http:");

    /* ========= NAVIGATION ========= */
    function showPage(id){
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      const el = document.getElementById(id);
      if(el) el.classList.add("active");
      if(id === "page-favs") renderFavorites();
      if(id === "page-channels") renderChannels();
      if(id === "page-history") renderHistoryPage();
      if(id === "page-options") renderOptionsUI();
    }

    document.addEventListener("click", (e)=>{
      const go = e.target.closest("[data-go]");
      if(go) showPage(go.dataset.go);
      const back = e.target.closest("[data-back]");
      if(back) showPage(back.dataset.back);
    });

    /* ========= TOAST ========= */
    const toastWrap = document.getElementById("toast-wrap");
    function toast(msg){
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = msg;
      toastWrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; }, 1500);
      setTimeout(()=>{ el.remove(); }, 1900);
    }

    /* ========= OVERLAY ========= */
    const overlay = document.getElementById("overlay");
    const overlayTitle = document.getElementById("overlay-title");
    const overlaySub = document.getElementById("overlay-sub");

    function showOverlay(title, sub){
      overlayTitle.textContent = title || "Chargement…";
      overlaySub.textContent = sub || "Merci de patienter";
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden", "false");
    }
    function hideOverlay(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden", "true");
    }

    /* ========= OPEN YT (FAST) =========
       ✅ Remplace l'ancienne méthode iframe caché
       -> tente app (mobile) puis fallback web très rapide
       -> annule le fallback si la page devient hidden
    */
    function openYouTubePreferApp(videoId){
      const webUrl = `https://www.youtube.com/watch?v=${videoId}`;
      const appUrl = `youtube://watch?v=${videoId}`;
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      if(!isMobile){
        window.open(webUrl, "_blank", "noopener,noreferrer");
        return;
      }

      let didHide = false;
      const onVis = ()=>{
        if(document.visibilityState === "hidden"){
          didHide = true; // l'app YouTube a pris la main
        }
      };
      document.addEventListener("visibilitychange", onVis, { passive:true });

      // tente d'ouvrir l'app
      try{ window.location.href = appUrl; }catch{}

      // fallback web très court (évite la lenteur de la 1ère vidéo)
      const t = setTimeout(()=>{
        document.removeEventListener("visibilitychange", onVis);
        if(!didHide){
          // fallback web
          window.location.href = webUrl;
        }
      }, 450);

      // sécurité : si on cache la page après, on stoppe le fallback
      setTimeout(()=>{
        if(didHide){
          clearTimeout(t);
          document.removeEventListener("visibilitychange", onVis);
        }
      }, 800);
    }

    /* ========= OPTIONS (Lecteur intégré) ========= */
    const OPTS_KEY = "yt_options_v1";
    const DEFAULT_OPTS = { embedPlayer: true };

    function loadOptions(){
      try{
        const raw = localStorage.getItem(OPTS_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        return { ...DEFAULT_OPTS, ...(obj || {}) };
      }catch{
        return { ...DEFAULT_OPTS };
      }
    }
    function saveOptions(opts){
      try{ localStorage.setItem(OPTS_KEY, JSON.stringify(opts)); }catch{}
    }
    function setOption(key, value){
      const o = loadOptions();
      o[key] = value;
      saveOptions(o);
      return o;
    }

    // ✅ IMPORTANT: en file:// on force embed OFF (sinon erreur 153 / écran noir)
    function isEmbedEnabled(){
      if(IS_FILE) return false;
      return !!loadOptions().embedPlayer;
    }

    const embedSwitchEl = document.getElementById("opt-embed-switch");
    const embedDescEl = document.getElementById("opt-embed-desc");

    function applySwitchUI(){
      if(!embedSwitchEl) return;

      const on = isEmbedEnabled();
      embedSwitchEl.classList.toggle("on", on);
      embedSwitchEl.setAttribute("aria-checked", on ? "true" : "false");

      if(IS_FILE){
        embedSwitchEl.classList.add("disabled");
        if(embedDescEl){
          embedDescEl.innerHTML =
            `⚠️ <b>Mode local (file://)</b> : YouTube bloque souvent l’IFrame Player (erreur 153).<br>`+
            `Le lecteur intégré est donc <b>désactivé automatiquement</b> ici.<br>`+
            `➡️ Pour tester le lecteur : ouvre la page via <b>GitHub Pages</b> ou un <b>petit serveur local</b> (http://localhost).`;
        }
      }else{
        embedSwitchEl.classList.remove("disabled");
      }
    }

    function renderOptionsUI(){
      applySwitchUI();
    }

    function toggleEmbed(){
      if(IS_FILE){
        toast("En local (file://), le lecteur intégré est désactivé (erreur 153).");
        return;
      }
      const now = !isEmbedEnabled();
      setOption("embedPlayer", now);
      applySwitchUI();
      toast(now ? "Lecteur intégré : activé ✅" : "Lecteur intégré : désactivé ✅");

      // ✅ précharge l’API si on vient d’activer (accélère la 1ère lecture)
      if(now) ensureYouTubeIframeApi(true);
    }

    if(embedSwitchEl){
      embedSwitchEl.addEventListener("click", toggleEmbed);
      embedSwitchEl.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          toggleEmbed();
        }
      });
    }

    /* ========= MODAL PLAYER + IFrame API ========= */
    const playerModal = document.getElementById("player-modal");
    const playerTitleEl = document.getElementById("player-title");
    const playerFootRight = document.getElementById("player-foot-right");
    const playerBtnClose = document.getElementById("player-close");
    const playerBtnNext  = document.getElementById("player-next");
    const playerBtnOpen  = document.getElementById("player-open");

    let ytPlayer = null;
    let ytApiReady = false;
    let pendingVideoId = null;

    // contexte "random"
    let currentEntry = null;
    let currentChosenCh = null;
    let currentVideoId = null;

    function ensureYouTubeIframeApi(force=false){
      if(IS_FILE) return; // ✅ jamais en file://
      if(window.__yt_iframe_api_loading && !force) return;
      window.__yt_iframe_api_loading = true;
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
    }

    window.onYouTubeIframeAPIReady = function(){
      ytApiReady = true;
      if(pendingVideoId){
        createOrLoadPlayer(pendingVideoId);
        pendingVideoId = null;
      }
    };

    function createOrLoadPlayer(videoId){
      if(IS_FILE){
        toast("Lecteur intégré indisponible en mode local (file://). Ouverture YouTube…");
        openYouTubePreferApp(videoId);
        return;
      }

      if(!ytApiReady){
        pendingVideoId = videoId;
        ensureYouTubeIframeApi();
        return;
      }

      if(ytPlayer){
        ytPlayer.loadVideoById(videoId);
        return;
      }

      const origin = (IS_HTTPS && location.origin) ? location.origin : undefined;

      ytPlayer = new YT.Player("yt-player", {
        videoId,
        playerVars: {
          autoplay: 1,
          rel: 0,
          modestbranding: 1,
          playsinline: 1,
          ...(origin ? { origin } : {})
        },
        events: {
          onReady: (ev)=> { try{ ev.target.playVideo(); }catch{} },
          onStateChange: (ev)=>{
            if(ev.data === YT.PlayerState.ENDED){
              playerNextRandom();
            }
          },
          onError: ()=> {
            toast("Lecteur : erreur. Ouverture YouTube…");
            if(currentVideoId) openYouTubePreferApp(currentVideoId);
          }
        }
      });
    }

    function openPlayerModal(){
      playerModal.classList.add("show");
      playerModal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }
    function closePlayerModal(){
      playerModal.classList.remove("show");
      playerModal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "hidden";
      try{ ytPlayer && ytPlayer.stopVideo(); }catch{}
    }

    playerBtnClose.addEventListener("click", closePlayerModal);
    playerModal.addEventListener("click", (e)=>{ if(e.target === playerModal) closePlayerModal(); });
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && playerModal.classList.contains("show")) closePlayerModal();
    });

    playerBtnOpen.addEventListener("click", ()=>{
      if(currentVideoId) openYouTubePreferApp(currentVideoId);
    });

    async function playerNextRandom(){
      if(!currentEntry){
        toast("Impossible : pas de contexte random.");
        return;
      }
      await launchEntry(currentEntry, { forceEmbed: true });
    }
    playerBtnNext.addEventListener("click", playerNextRandom);

    function playInModal(videoId, titleText){
      currentVideoId = videoId;
      playerTitleEl.textContent = titleText || "Lecture…";
      playerFootRight.textContent = `ID : ${videoId}`;
      openPlayerModal();
      ensureYouTubeIframeApi();
      createOrLoadPlayer(videoId);
    }

    /* ========= CONFIG ========= */
    const apiKey = "AIzaSyBVx63xYeRm34oQIsCigJozDp9hIoRLhxo"; // <-- Ta clé

    function normalizeChannelId(id){
      const s = String(id || "").trim();
      if(s.startsWith("UC")) return s;
      if(s.length === 22) return "UC" + s;
      return s;
    }

    const CHANNEL_FUZE3_ID   = normalizeChannelId("UCfznY5SlSoZoXN0-kBPtCdg");
    const CHANNEL_FIOUSE_ID  = normalizeChannelId("UCBIVKUsOGwCg8RNpucEGp_g");
    const CHANNEL_AMIXEM_ID  = normalizeChannelId("UCgvqvBoSHB1ctlyyhoHrGwQ");
    const CHANNEL_SQUEEZIE_ID= normalizeChannelId("UCWeg2Pkate69NFdBeuRFTAw");
    const CHANNEL_MEC_ID     = normalizeChannelId("UCDPK_MTu3uTUFJXRVcTJcEw");
    const CHANNEL_INOXTAG_ID = normalizeChannelId("UCL9aTJb0ur4sovxcppAopEw");
    const CHANNEL_JOYCA_ID   = normalizeChannelId("UCow2IGnug1l3Xazkrc5jM_Q");
    const CHANNEL_MASTU_ID   = normalizeChannelId("AhaFPP6v3WCfK5Tjao0B7A"); // (si ça bug, mets le vrai UC...)

    const CHANNEL_LEGEND_ID  = normalizeChannelId("UCIh7PDUAP226Pa_NtjN9Jqw");
    const CHANNEL_DJILSI_ID  = normalizeChannelId("UCEUZRSYr1a2hnBfnpWslFeQ");
    const CHANNEL_SYLVAIN_ID = normalizeChannelId("UCd26XTdCltsEpyvZmmGW9Aw");
    const CHANNEL_WANKIL_ID  = normalizeChannelId("UCYGjxo5ifuhnmvhPvCc3DJQ");
    const CHANNEL_GOTAGA_ID  = normalizeChannelId("UCwDeagCMN0rTg5-r3s9AINA");

    const MIN_SECONDS = 61;
    const LATEST_MIN_SECONDS = 181;
    const CACHE_TTL_MS = 48 * 60 * 60 * 1000;

    const MAX_PAGES = 200;
    const MAX_VIDEOS = 6000;

    const CH_FUZE3    = { key:"fuze3",    name:"Fuze III", id:CHANNEL_FUZE3_ID,   cutoffType:"yearsBack", yearsBack:6 };
    const CH_FIOUSE   = { key:"fiouse",   name:"Fiouse",   id:CHANNEL_FIOUSE_ID,  cutoffType:"sinceIso",  sinceIso:"2023-01-01T00:00:00Z" };
    const CH_AMIXEM   = { key:"amixem",   name:"Amixem",   id:CHANNEL_AMIXEM_ID,  cutoffType:"yearsBack", yearsBack:6 };
    const CH_SQUEEZIE = { key:"squeezie", name:"Squeezie", id:CHANNEL_SQUEEZIE_ID,cutoffType:"yearsBack", yearsBack:7 };
    const CH_MEC      = { key:"mec",      name:"MacFly et Carlito", id:CHANNEL_MEC_ID, cutoffType:"yearsBack", yearsBack:4 };
    const CH_INOXTAG  = { key:"inoxtag",  name:"Inoxtag",  id:CHANNEL_INOXTAG_ID, cutoffType:"yearsBack", yearsBack:5 };
    const CH_JOYCA    = { key:"joyca",    name:"Joyca",    id:CHANNEL_JOYCA_ID,   cutoffType:"yearsBack", yearsBack:5 };
    const CH_MASTU    = { key:"mastu",    name:"Mastu",    id:CHANNEL_MASTU_ID,   cutoffType:"yearsBack", yearsBack:5 };

    const CH_LEGEND   = { key:"legend",   name:"LEGEND",   id:CHANNEL_LEGEND_ID,  cutoffType:"yearsBack", yearsBack:5 };
    const CH_DJILSI   = { key:"djilsi",   name:"DJILSI",   id:CHANNEL_DJILSI_ID,  cutoffType:"yearsBack", yearsBack:5 };
    const CH_SYLVAIN  = { key:"sylvain",  name:"SYLVAIN LYVE", id:CHANNEL_SYLVAIN_ID, cutoffType:"yearsBack", yearsBack:5 };
    const CH_WANKIL   = { key:"wankil",   name:"Wankil Studio - Laink et Terracid", id:CHANNEL_WANKIL_ID, cutoffType:"yearsBack", yearsBack:5 };
    const CH_GOTAGA   = { key:"gotaga",   name:"GOTAGA",   id:CHANNEL_GOTAGA_ID,  cutoffType:"yearsBack", yearsBack:5 };

    const CHANNELS_ALL = [
      CH_FUZE3, CH_FIOUSE, CH_AMIXEM, CH_SQUEEZIE, CH_MEC, CH_INOXTAG, CH_JOYCA, CH_MASTU,
      CH_LEGEND, CH_DJILSI, CH_SYLVAIN, CH_WANKIL, CH_GOTAGA
    ];

    let isPicking = false;

    /* ========= UTILS ========= */
    function isoDurationToSeconds(iso){
      const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      return (+(m?.[1]||0))*3600 + (+(m?.[2]||0))*60 + (+(m?.[3]||0));
    }
    async function fetchJson(url){
      const r = await fetch(url);
      const d = await r.json();
      if(!r.ok) throw new Error(d?.error?.message || "Erreur API");
      return d;
    }
    function cutoffMsForChannel(ch){
      if (ch.cutoffType === "yearsBack"){
        const d = new Date();
        d.setFullYear(d.getFullYear() - (ch.yearsBack || 6));
        return d.getTime();
      }
      return new Date(ch.sinceIso).getTime();
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatDuration(ms){
      if(ms <= 0) return "0h";
      const s = Math.floor(ms/1000);
      const days = Math.floor(s/86400);
      const hours = Math.floor((s%86400)/3600);
      const mins = Math.floor((s%3600)/60);
      if(days > 0) return `${days}j ${hours}h`;
      if(hours > 0) return `${hours}h ${pad2(mins)}m`;
      return `${mins}m`;
    }

    /* ========= FAVORIS ========= */
    const FAV_KEY = "yt_favorites_v1";
    function loadFavorites(){
      try{
        const raw = localStorage.getItem(FAV_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveFavorites(list){ localStorage.setItem(FAV_KEY, JSON.stringify(list)); }
    function isFav(entryId){ return loadFavorites().includes(entryId); }
    function toggleFav(entryId){
      const favs = loadFavorites();
      const idx = favs.indexOf(entryId);
      if(idx >= 0){
        favs.splice(idx, 1);
        saveFavorites(favs);
        return false;
      }else{
        favs.push(entryId);
        saveFavorites(favs);
        return true;
      }
    }

    /* ========= AVATAR (API + CACHE) ========= */
    const AVATAR_TTL_MS = 30 * 24 * 60 * 60 * 1000;
    function avatarCacheKey(channelId){ return `yt_avatar_${channelId}_v1`; }
    function avatarCacheTsKey(channelId){ return `yt_avatar_${channelId}_ts_v1`; }

    function loadCachedAvatar(channelId){
      try{
        const url = localStorage.getItem(avatarCacheKey(channelId)) || "";
        const ts = Number(localStorage.getItem(avatarCacheTsKey(channelId)) || 0);
        if(!url || !ts) return "";
        if(Date.now() - ts > AVATAR_TTL_MS) return "";
        return url;
      }catch{ return ""; }
    }
    function saveCachedAvatar(channelId, url){
      try{
        localStorage.setItem(avatarCacheKey(channelId), url);
        localStorage.setItem(avatarCacheTsKey(channelId), String(Date.now()));
      }catch{}
    }
    async function fetchChannelAvatarUrl(channelId){
      const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${channelId}&key=${apiKey}`;
      const data = await fetchJson(url);
      const thumbs = data?.items?.[0]?.snippet?.thumbnails;
      return thumbs?.medium?.url || thumbs?.default?.url || thumbs?.high?.url || "";
    }
    async function ensureAvatarFor(channelId){
      const cached = loadCachedAvatar(channelId);
      if(cached) return cached;
      const avatarUrl = await fetchChannelAvatarUrl(channelId);
      if(avatarUrl) saveCachedAvatar(channelId, avatarUrl);
      return avatarUrl || "";
    }

    /* ========= SUBSCRIBERS (CACHE 7 JOURS) ========= */
    const SUBS_TTL_MS = 7 * 24 * 60 * 60 * 1000;
    function subsKey(channelId){ return `yt_subs_${channelId}_v1`; }
    function subsTsKey(channelId){ return `yt_subs_${channelId}_ts_v1`; }

    function loadSubs(channelId){
      try{
        const raw = localStorage.getItem(subsKey(channelId));
        const ts = Number(localStorage.getItem(subsTsKey(channelId)) || 0);
        if(!raw || !ts) return null;
        if(Date.now() - ts > SUBS_TTL_MS) return null;
        const n = Number(raw);
        return Number.isFinite(n) ? n : null;
      }catch{ return null; }
    }
    function saveSubs(channelId, n){
      try{
        localStorage.setItem(subsKey(channelId), String(n));
        localStorage.setItem(subsTsKey(channelId), String(Date.now()));
      }catch{}
    }
    async function fetchSubs(channelId){
      const url = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}&key=${apiKey}`;
      const data = await fetchJson(url);
      const s = data?.items?.[0]?.statistics?.subscriberCount;
      const n = Number(s);
      if(!Number.isFinite(n)) return -1;
      saveSubs(channelId, n);
      return n;
    }
    async function ensureSubs(channelId){
      const cached = loadSubs(channelId);
      if(cached !== null) return cached;
      return await fetchSubs(channelId);
    }

    /* ========= KEYS ========= */
    function keysFor(ch){
      const base = `yt_${ch.key}_${ch.id}_${MIN_SECONDS}s`;
      return {
        IDS:  `${base}_pool_ids_v1`,
        META: `${base}_pool_meta_v1`,
        TS:   `${base}_pool_ts_v1`,
        SEEN: `${base}_seen_v1`
      };
    }

    /* ========= CACHE (POOLS RANDOM) ========= */
    function loadCache(ch){
      const k = keysFor(ch);
      try{
        const idsRaw = localStorage.getItem(k.IDS);
        const metaRaw = localStorage.getItem(k.META);
        const tsRaw = localStorage.getItem(k.TS);
        if(!idsRaw || !metaRaw || !tsRaw) return null;

        const poolIds = JSON.parse(idsRaw);
        const metaMap = JSON.parse(metaRaw);
        const meta = JSON.parse(tsRaw);

        if(!Array.isArray(poolIds) || !meta?.ts) return null;
        if(Date.now() - meta.ts > CACHE_TTL_MS) return null;

        return { poolIds, metaMap, meta };
      }catch{
        return null;
      }
    }

    function saveCache(ch, poolIds, metaMap, extra={}){
      const k = keysFor(ch);
      const meta = { ts: Date.now(), count: poolIds.length, ...extra };
      localStorage.setItem(k.IDS, JSON.stringify(poolIds));
      localStorage.setItem(k.META, JSON.stringify(metaMap));
      localStorage.setItem(k.TS, JSON.stringify(meta));
      return meta;
    }

    function removeFromCache(ch, videoId){
      const cached = loadCache(ch);
      if(!cached || !Array.isArray(cached.poolIds)) return;
      const idx = cached.poolIds.indexOf(videoId);
      if(idx === -1) return;
      cached.poolIds.splice(idx, 1);
      saveCache(ch, cached.poolIds, cached.metaMap, { pruned_to: cached.poolIds.length });
    }

    /* ========= HISTORIQUE ========= */
    const GLOBAL_HISTORY_KEY = "yt_history_global_v1";

    function loadGlobalHistory(){
      try{
        const raw = localStorage.getItem(GLOBAL_HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveGlobalHistory(arr){
      try{ localStorage.setItem(GLOBAL_HISTORY_KEY, JSON.stringify(arr)); }catch{}
    }
    function addGlobalHistoryItem(ch, videoId){
      const arr = loadGlobalHistory();
      arr.push({ t: Date.now(), chKey: ch.key, id: videoId });
      const MAX = 20000;
      const trimmed = arr.slice(Math.max(0, arr.length - MAX));
      saveGlobalHistory(trimmed);
    }
    function removeGlobalHistoryByChannelKey(chKey){
      const arr = loadGlobalHistory();
      saveGlobalHistory(arr.filter(x => x?.chKey !== chKey));
    }
    function clearGlobalHistory(){
      try{ localStorage.removeItem(GLOBAL_HISTORY_KEY); }catch{}
    }

    function loadSeenList(ch){
      const k = keysFor(ch);
      try{
        const raw = localStorage.getItem(k.SEEN);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    function saveSeenList(ch, list){
      const k = keysFor(ch);
      const MAX_SEEN = 10000;
      const trimmed = list.slice(Math.max(0, list.length - MAX_SEEN));
      localStorage.setItem(k.SEEN, JSON.stringify(trimmed));
    }
    function resetSeenAll(){
      for(const ch of CHANNELS_ALL){
        const k = keysFor(ch);
        localStorage.removeItem(k.SEEN);
      }
      clearGlobalHistory();
    }
    function resetSeenForChannel(ch){
      const k = keysFor(ch);
      localStorage.removeItem(k.SEEN);
      removeGlobalHistoryByChannelKey(ch.key);
    }

    function seenCountFor(ch){ return loadSeenList(ch).length; }
    function remainingCountFor(ch){ return loadCache(ch)?.poolIds?.length || 0; }

    function rebuildTimeLeftForGroup(group){
      const now = Date.now();
      const times = [];
      for(const ch of group){
        const cached = loadCache(ch);
        if(cached?.meta?.ts){
          const left = CACHE_TTL_MS - (now - cached.meta.ts);
          times.push(left);
        }
      }
      if(times.length === 0) return "charger une vidéo random";
      const minLeft = Math.min(...times);
      if(minLeft <= 0) return "charger une vidéo random";
      return formatDuration(minLeft);
    }

    /* ========= YT quota-min ========= */
    async function getUploadsPlaylistId(channelId){
      const url = `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${channelId}&key=${apiKey}`;
      const data = await fetchJson(url);
      const uploads = data?.items?.[0]?.contentDetails?.relatedPlaylists?.uploads;
      if(!uploads) throw new Error("Impossible de récupérer la playlist Uploads.");
      return uploads;
    }

    async function collectVideoIdsUpToCutoff(uploadsPlaylistId, cutoffMs){
      let pageToken = "";
      const all = [];

      for(let page=0; page<200; page++){
        const url =
          `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails`+
          `&playlistId=${uploadsPlaylistId}&maxResults=50`+
          (pageToken ? `&pageToken=${pageToken}` : "")+
          `&key=${apiKey}`;

        const data = await fetchJson(url);
        const items = data.items || [];
        if(!items.length) break;

        let reachedOld = false;

        for(const it of items){
          const publishedAt = it?.snippet?.publishedAt;
          const ms = publishedAt ? new Date(publishedAt).getTime() : null;
          const vid = it?.contentDetails?.videoId;
          if(!vid || !ms) continue;

          if(ms < cutoffMs){ reachedOld = true; break; }

          all.push(vid);
          if(all.length >= 6000){ reachedOld = true; break; }
        }

        if(reachedOld) break;
        if(!data.nextPageToken) break;
        pageToken = data.nextPageToken;
      }

      return all;
    }

    async function buildMetaAndFilterNoShorts(videoIds){
      const poolIds = [];
      const metaMap = {}; // id -> [title, thumb]

      for(let i=0; i<videoIds.length; i+=50){
        const chunk = videoIds.slice(i, i+50);
        const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${chunk.join(",")}&key=${apiKey}`;
        const data = await fetchJson(url);

        for(const v of (data.items || [])){
          const id = v?.id;
          const iso = v?.contentDetails?.duration;
          if(!id || !iso) continue;

          const sec = isoDurationToSeconds(iso);
          const sn = v?.snippet;

          const thumb =
            sn?.thumbnails?.default?.url ||
            sn?.thumbnails?.medium?.url ||
            sn?.thumbnails?.high?.url ||
            "";

          const title = (sn?.title || "").trim();
          metaMap[id] = [title, thumb];

          if(sec >= MIN_SECONDS) poolIds.push(id);
        }
      }

      return { poolIds, metaMap };
    }

    async function buildPoolForChannel(ch, force=false){
      if(!force){
        const cached = loadCache(ch);
        if(cached) return cached;
      }

      toast(`Rebuild ${ch.name}…`);
      showOverlay(`Rebuild en cours : ${ch.name}`, "Création du cache (anti-shorts) — ça peut prendre un moment…");

      try{
        const cutoff = cutoffMsForChannel(ch);
        const uploadsId = await getUploadsPlaylistId(ch.id);
        const ids = await collectVideoIdsUpToCutoff(uploadsId, cutoff);
        const built = await buildMetaAndFilterNoShorts(ids);

        if(!built.poolIds.length) throw new Error(`Pool vide pour ${ch.name} (beaucoup de shorts ?).`);

        const uniquePool = Array.from(new Set(built.poolIds));

        const seenSet = new Set(loadSeenList(ch));
        const prunedPoolIds = uniquePool.filter(id => !seenSet.has(id));

        saveCache(ch, prunedPoolIds, built.metaMap, {
          raw: ids.length,
          pruned_from: built.poolIds.length,
          unique_from: uniquePool.length,
          pruned_to: prunedPoolIds.length
        });

        toast(`✅ Rebuild terminé : ${ch.name}`);
        return { poolIds: prunedPoolIds, metaMap: built.metaMap, meta: { ts: Date.now(), count: prunedPoolIds.length } };
      } finally {
        hideOverlay();
      }
    }

    function pickFromPool(ch, poolIds){
      if(!poolIds || poolIds.length === 0){
        throw new Error(`Plus de vidéos dispo pour ${ch.name}. Fais un rebuild.`);
      }

      const pickedId = poolIds[Math.floor(Math.random() * poolIds.length)];

      const seen = loadSeenList(ch);
      if(!seen.includes(pickedId)){
        seen.push(pickedId);
        saveSeenList(ch, seen);
        addGlobalHistoryItem(ch, pickedId);
      }

      return pickedId;
    }

    /* ========= ENTRIES ========= */
    const ENTRY_FUZE_RANDOM = {
      entryId: "entry_fuze_random_50",
      title: "Fuze III",
      yearsText: "Fuze III / Fiouse",
      avatarChannelId: CHANNEL_FUZE3_ID,
      type: "group_random",
      group: [CH_FUZE3, CH_FIOUSE]
    };

    function makeSingleEntry(key, title, channel, avatarChannelId){
      return { entryId: `entry_${key}`, title, yearsText: title, avatarChannelId, type: "single_random", channel };
    }

    const ENTRIES = [
      ENTRY_FUZE_RANDOM,
      makeSingleEntry("amixem",   "Amixem",            CH_AMIXEM,   CHANNEL_AMIXEM_ID),
      makeSingleEntry("squeezie", "Squeezie",          CH_SQUEEZIE, CHANNEL_SQUEEZIE_ID),
      makeSingleEntry("mec",      "MacFly et Carlito", CH_MEC,      CHANNEL_MEC_ID),
      makeSingleEntry("inoxtag",  "Inoxtag",           CH_INOXTAG,  CHANNEL_INOXTAG_ID),
      makeSingleEntry("joyca",    "Joyca",             CH_JOYCA,    CHANNEL_JOYCA_ID),
      makeSingleEntry("mastu",    "Mastu",             CH_MASTU,    CHANNEL_MASTU_ID),
      makeSingleEntry("legend",   "LEGEND",            CH_LEGEND,   CHANNEL_LEGEND_ID),
      makeSingleEntry("djilsi",   "DJILSI",            CH_DJILSI,   CHANNEL_DJILSI_ID),
      makeSingleEntry("sylvain",  "SYLVAIN LYVE",      CH_SYLVAIN,  CHANNEL_SYLVAIN_ID),
      makeSingleEntry("wankil",   "Wankil Studio - Laink et Terracid", CH_WANKIL, CHANNEL_WANKIL_ID),
      makeSingleEntry("gotaga",   "GOTAGA",            CH_GOTAGA,   CHANNEL_GOTAGA_ID),
    ];

    /* ========= LAUNCH RANDOM ========= */
    async function launchEntry(entry, opts = {}){
      if(isPicking) return;
      isPicking = true;

      try{
        const embed = (typeof opts.forceEmbed === "boolean") ? opts.forceEmbed : isEmbedEnabled();
        currentEntry = entry;

        let chosenCh = null;
        if(entry.type === "group_random"){
          chosenCh = (Math.random() < 0.5) ? entry.group[0] : entry.group[1];
        } else {
          chosenCh = entry.channel;
        }
        currentChosenCh = chosenCh;

        const built = await buildPoolForChannel(chosenCh, false);
        const vid = pickFromPool(chosenCh, built.poolIds);
        removeFromCache(chosenCh, vid);

        const meta = built?.metaMap?.[vid];
        const vidTitle = meta?.[0] || `${entry.title} — vidéo random`;

        if(embed) playInModal(vid, vidTitle);
        else openYouTubePreferApp(vid);

        renderChannels();
        renderFavorites();
        if(document.getElementById("page-history")?.classList.contains("active")) renderHistoryPage();

      }catch(e){
        console.error(e);
        toast("Erreur : " + (e.message || e));
      }finally{
        isPicking = false;
      }
    }

    /* ========= STATS LINES ========= */
    function headerLineForEntry(entry){
      if(entry.type === "group_random"){
        const timeLeft = rebuildTimeLeftForGroup(entry.group);
        return `• ${entry.yearsText} • Rebuild : ${timeLeft}`;
      } else {
        const timeLeft = rebuildTimeLeftForGroup([entry.channel]);
        return `• Rebuild : ${timeLeft}`;
      }
    }

    function fullStatsForEntry(entry){
      if(entry.type === "group_random"){
        const remaining = remainingCountFor(entry.group[0]) + remainingCountFor(entry.group[1]);
        const seen = seenCountFor(entry.group[0]) + seenCountFor(entry.group[1]);
        return `Vidéos dispo : ${remaining} • Déjà vues : ${seen}`;
      } else {
        const remaining = remainingCountFor(entry.channel);
        const seen = seenCountFor(entry.channel);
        return `Vidéos dispo : ${remaining} • Déjà vues : ${seen}`;
      }
    }

    /* ========= MYSTERY THUMB ========= */
    function pickMysteryThumbFromChannel(ch){
      const cached = loadCache(ch);
      if(!cached) return "";
      const metaMap = cached.metaMap || {};
      let ids = Array.isArray(cached.poolIds) ? cached.poolIds.slice() : [];
      if(!ids.length) ids = Object.keys(metaMap);
      if(!ids.length) return "";
      const id = ids[Math.floor(Math.random() * ids.length)];
      const meta = metaMap[id];
      return meta && meta[1] ? meta[1] : "";
    }
    function getMysteryThumbUrl(entry){
      if(entry.type === "group_random"){
        const a = entry.group[0], b = entry.group[1];
        if(Math.random() < 0.5){
          return pickMysteryThumbFromChannel(a) || pickMysteryThumbFromChannel(b) || "";
        }
        return pickMysteryThumbFromChannel(b) || pickMysteryThumbFromChannel(a) || "";
      }
      return pickMysteryThumbFromChannel(entry.channel) || "";
    }

    /* ========= DERNIÈRE VIDÉO (cache 6h) ========= */
    const LATEST_TTL_MS = 6 * 60 * 60 * 1000;

    function latestKey(channelId){ return `yt_latest_${channelId}_v2`; }
    function latestTsKey(channelId){ return `yt_latest_${channelId}_ts_v2`; }

    function loadLatest(channelId){
      try{
        const raw = localStorage.getItem(latestKey(channelId));
        const ts = Number(localStorage.getItem(latestTsKey(channelId)) || 0);
        if(!raw || !ts) return null;
        if(Date.now() - ts > LATEST_TTL_MS) return null;
        const obj = JSON.parse(raw);
        if(!obj?.videoId) return null;
        return obj;
      }catch{ return null; }
    }
    function saveLatest(channelId, obj){
      try{
        localStorage.setItem(latestKey(channelId), JSON.stringify(obj));
        localStorage.setItem(latestTsKey(channelId), String(Date.now()));
      }catch{}
    }
    function clearLatest(channelId){
      try{
        localStorage.removeItem(latestKey(channelId));
        localStorage.removeItem(latestTsKey(channelId));
      }catch{}
    }

    async function fetchLatestVideo(channelId){
      const uploadsId = await getUploadsPlaylistId(channelId);

      const N = 12;
      const url =
        `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${uploadsId}`+
        `&maxResults=${N}&key=${apiKey}`;
      const data = await fetchJson(url);

      const items = data?.items || [];
      const ids = [];
      for(const it of items){
        const vid = it?.snippet?.resourceId?.videoId;
        if(vid) ids.push(vid);
      }
      if(!ids.length) throw new Error("Dernière vidéo introuvable.");

      const vUrl =
        `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,snippet&id=${ids.join(",")}&key=${apiKey}`;
      const vData = await fetchJson(vUrl);

      for(const v of (vData.items || [])){
        const id = v?.id;
        const iso = v?.contentDetails?.duration;
        if(!id || !iso) continue;

        const sec = isoDurationToSeconds(iso);
        if(sec < LATEST_MIN_SECONDS) continue;

        const sn = v?.snippet || {};
        const thumbs = sn?.thumbnails || {};
        const thumb =
          thumbs?.maxres?.url ||
          thumbs?.standard?.url ||
          thumbs?.high?.url ||
          thumbs?.medium?.url ||
          thumbs?.default?.url ||
          "";

        const title = (sn?.title || "").trim();
        const obj = { videoId: id, title: title || "(Sans titre)", thumb };

        saveLatest(channelId, obj);
        return obj;
      }

      throw new Error("Aucune vidéo assez longue trouvée parmi les derniers uploads.");
    }

    async function ensureLatest(channelId){
      const cached = loadLatest(channelId);
      if(cached) return cached;
      return await fetchLatestVideo(channelId);
    }

    function uniqueLatestChannelIds(){
      const set = new Set();
      for(const e of ENTRIES) set.add(e.avatarChannelId);
      return Array.from(set);
    }

    /* ========= ACCORDEON UI ========= */
    const channelsListEl = document.getElementById("channels-list");
    const favoritesListEl = document.getElementById("favorites-list");
    const favoritesEmptyEl = document.getElementById("favorites-empty");

    const channelsSearchEl = document.getElementById("channels-search");
    const channelsSortEl = document.getElementById("channels-sort");

    function setExpandHeight(card, expandEl){
      if(!card.classList.contains("open")){
        expandEl.style.maxHeight = "0px";
        return;
      }
      expandEl.style.maxHeight = expandEl.scrollHeight + "px";
    }

    async function fillLatestUI(entry, expandInner, card, expand){
      const channelId = entry.avatarChannelId;
      expandInner.innerHTML = `<div class="latest-loading">Chargement de la dernière vidéo…</div>`;

      try{
        const latest = await ensureLatest(channelId);

        const openLatest = (e)=>{
          e.stopPropagation();
          if(isEmbedEnabled()) playInModal(latest.videoId, latest.title || "Dernière vidéo");
          else openYouTubePreferApp(latest.videoId);
        };

        const wrap = document.createElement("div");

        const t = document.createElement("div");
        t.className = "latest-title";
        t.textContent = "Dernière vidéo en ligne";
        wrap.appendChild(t);

        const row = document.createElement("div");
        row.className = "latest-row";

        const img = document.createElement("img");
        img.className = "latest-thumb";
        img.alt = "Miniature dernière vidéo";
        if(latest.thumb) img.src = latest.thumb;
        img.addEventListener("click", openLatest);

        const meta = document.createElement("div");
        meta.className = "latest-meta";

        const title = document.createElement("div");
        title.className = "latest-video-title";
        title.textContent = latest.title || "(Sans titre)";
        title.addEventListener("click", openLatest);

        const hint = document.createElement("div");
        hint.className = "latest-hint";
        hint.textContent = isEmbedEnabled()
          ? "Clique pour lire dans l’appli (lecteur intégré)."
          : "Clique pour ouvrir sur YouTube.";

        meta.appendChild(title);
        meta.appendChild(hint);

        row.appendChild(img);
        row.appendChild(meta);
        wrap.appendChild(row);

        const rt = document.createElement("div");
        rt.className = "random-title";
        rt.textContent = "Vidéo aléatoire";
        wrap.appendChild(rt);

        const rrow = document.createElement("div");
        rrow.className = "random-row";

        const rthumb = document.createElement("div");
        rthumb.className = "random-thumb";
        rthumb.title = "Lancer une vidéo random";

        const mysteryImg = document.createElement("img");
        mysteryImg.className = "mystery-img";
        mysteryImg.alt = "";
        mysteryImg.loading = "lazy";

        const refreshMystery = ()=>{
          const u = getMysteryThumbUrl(entry);
          if(u) mysteryImg.src = u;
        };
        refreshMystery();
        rthumb.appendChild(mysteryImg);

        const rmeta = document.createElement("div");
        rmeta.className = "random-meta";

        const raction = document.createElement("div");
        raction.className = "random-action";
        raction.textContent = "Lance une vidéo random";

        const rhint = document.createElement("div");
        rhint.className = "random-hint";
        rhint.textContent = "Tu ne sais pas sur quoi tu vas tomber 😄";

        const rstats = document.createElement("div");
        rstats.className = "random-stats";
        rstats.textContent = fullStatsForEntry(entry);

        const doRandom = (e)=>{
          e.stopPropagation();
          refreshMystery();
          launchEntry(entry);
        };

        rthumb.addEventListener("click", doRandom);
        raction.addEventListener("click", doRandom);

        rmeta.appendChild(raction);
        rmeta.appendChild(rhint);
        rmeta.appendChild(rstats);

        rrow.appendChild(rthumb);
        rrow.appendChild(rmeta);
        wrap.appendChild(rrow);

        expandInner.innerHTML = "";
        expandInner.appendChild(wrap);
        setExpandHeight(card, expand);

      }catch(err){
        expandInner.innerHTML = `<div class="latest-error">Impossible de charger la dernière vidéo (API / quota / réseau).</div>`;
        setExpandHeight(card, expand);
      }
    }

    function closeAllAccordions(container){
      container.querySelectorAll(".channel-item.open").forEach(card=>{
        card.classList.remove("open");
        const expand = card.querySelector(".channel-expand");
        if(expand) expand.style.maxHeight = "0px";
      });
    }

    function toggleAccordion(card){
      const expand = card.querySelector(".channel-expand");
      const expandInner = card.querySelector(".expand-inner");
      const entry = card._entry;

      const willOpen = !card.classList.contains("open");

      const container = card.parentElement;
      closeAllAccordions(container);

      card.classList.toggle("open", willOpen);

      if(willOpen){
        fillLatestUI(entry, expandInner, card, expand);
        expandInner.dataset.filled = "1";
      }

      setExpandHeight(card, expand);
    }

    function makeEntryCard(entry){
      const card = document.createElement("div");
      card.className = "channel-item";
      card._entry = entry;

      const main = document.createElement("div");
      main.className = "channel-main";

      const left = document.createElement("div");
      left.className = "channel-left";

      const img = document.createElement("img");
      img.className = "channel-avatar hidden";
      img.alt = entry.title;

      const fallback = document.createElement("div");
      fallback.className = "channel-fallback";
      fallback.textContent = (entry.title || "X")[0].toUpperCase();

      const text = document.createElement("div");
      text.className = "channel-text";

      const name = document.createElement("div");
      name.className = "channel-name";
      name.textContent = entry.title;

      const sub = document.createElement("div");
      sub.className = "channel-sub";
      sub.textContent = headerLineForEntry(entry);

      text.appendChild(name);
      text.appendChild(sub);

      left.appendChild(img);
      left.appendChild(fallback);
      left.appendChild(text);

      const right = document.createElement("div");
      right.className = "channel-right";

      const starBtn = document.createElement("div");
      starBtn.className = "star-btn";
      starBtn.title = "Ajouter aux favoris";

      const star = document.createElement("div");
      star.className = "star" + (isFav(entry.entryId) ? " fav" : "");
      star.textContent = "★";
      starBtn.appendChild(star);

      starBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const on = toggleFav(entry.entryId);
        star.classList.toggle("fav", on);
        renderFavorites();
      });

      const chevBtn = document.createElement("div");
      chevBtn.className = "chev-btn";
      chevBtn.title = "Ouvrir";
      chevBtn.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 6l6 6-6 6z"></path></svg>`;

      right.appendChild(starBtn);
      right.appendChild(chevBtn);

      main.appendChild(left);
      main.appendChild(right);

      const expand = document.createElement("div");
      expand.className = "channel-expand";

      const expandInner = document.createElement("div");
      expandInner.className = "expand-inner";
      expand.appendChild(expandInner);

      expand.addEventListener("click", (e)=> e.stopPropagation());

      card.appendChild(main);
      card.appendChild(expand);

      main.addEventListener("click", ()=> toggleAccordion(card));

      chevBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        toggleAccordion(card);
      });

      (async ()=>{
        try{
          const url = await ensureAvatarFor(entry.avatarChannelId);
          if(url){
            img.src = url;
            img.classList.remove("hidden");
            fallback.classList.add("hidden");
          }
        }catch{}
      })();

      return card;
    }

    /* ========= Recherche + Tri ========= */
    let renderToken = 0;

    function filterEntriesBySearch(entries){
      const q = String(channelsSearchEl.value || "").trim().toLowerCase();
      if(!q) return entries;
      return entries.filter(e => (e.title || "").toLowerCase().includes(q));
    }

    async function sortEntries(entries){
      const mode = channelsSortEl.value || "default";
      const arr = entries.slice();

      if(mode === "az"){
        arr.sort((a,b)=> a.title.localeCompare(b.title, "fr", { sensitivity:"base" }));
        return arr;
      }
      if(mode === "za"){
        arr.sort((a,b)=> b.title.localeCompare(a.title, "fr", { sensitivity:"base" }));
        return arr;
      }

      if(mode === "subs_desc"){
        toast("Récupération des abonnés… (cache 7 jours)");
        showOverlay("Tri par abonnés…", "Lecture du cache abonnés / appel quota-mini si nécessaire…");
        const token = ++renderToken;

        try{
          const subsMap = new Map();
          for(const e of arr){
            if(token !== renderToken) return arr;
            const n = await ensureSubs(e.avatarChannelId);
            subsMap.set(e.entryId, n ?? -1);
          }

          arr.sort((a,b)=>{
            const sa = subsMap.get(a.entryId) ?? -1;
            const sb = subsMap.get(b.entryId) ?? -1;
            if(sb !== sa) return sb - sa;
            return a.title.localeCompare(b.title, "fr", { sensitivity:"base" });
          });

          return arr;
        } finally {
          hideOverlay();
        }
      }

      return arr;
    }

    async function renderChannels(){
      channelsListEl.innerHTML = "";
      let entries = ENTRIES.slice();
      entries = filterEntriesBySearch(entries);
      entries = await sortEntries(entries);

      for(const entry of entries){
        channelsListEl.appendChild(makeEntryCard(entry));
      }
    }

    async function renderFavorites(){
      const favs = loadFavorites();
      favoritesListEl.innerHTML = "";

      const items = ENTRIES.filter(e => favs.includes(e.entryId));

      if(items.length === 0){
        favoritesEmptyEl.classList.remove("hidden");
        return;
      }

      favoritesEmptyEl.classList.add("hidden");
      for(const entry of items){
        favoritesListEl.appendChild(makeEntryCard(entry));
      }
    }

    channelsSearchEl.addEventListener("input", ()=>{
      closeAllAccordions(channelsListEl);
      renderChannels();
    });
    channelsSortEl.addEventListener("change", ()=>{
      closeAllAccordions(channelsListEl);
      renderChannels();
    });

    /* ========= HISTORIQUE PAGE ========= */
    const histModeGlobalBtn = document.getElementById("hist-mode-global");
    const histModeChannelBtn = document.getElementById("hist-mode-channel");
    const histPickerWrap = document.getElementById("hist-channel-picker");
    const histSelect = document.getElementById("hist-channel-select");
    const histCopyBtn = document.getElementById("hist-copy");
    const histClearBtn = document.getElementById("hist-clear");
    const histTopline = document.getElementById("hist-topline");
    const histListEl = document.getElementById("history-list");

    let histMode = "global";

    function channelByKey(key){
      return CHANNELS_ALL.find(c => c.key === key) || null;
    }

    function buildChannelSelect(){
      histSelect.innerHTML = "";
      for(const ch of CHANNELS_ALL){
        const opt = document.createElement("option");
        opt.value = ch.key;
        opt.textContent = ch.name;
        histSelect.appendChild(opt);
      }
    }

    function resolveMetaThumbTitle(ch, videoId){
      const cached = loadCache(ch);
      const metaMap = cached?.metaMap || {};
      const meta = metaMap[videoId];
      const title = meta?.[0] || "(titre indisponible — rebuild conseillé)";
      const thumb = meta?.[1] || "";
      return { title, thumb };
    }

    function renderHistoryGlobal(){
      const arr = loadGlobalHistory();
      const total = arr.length;

      histTopline.textContent = `Total vidéos déjà sorties : ${total} (ordre global)`;
      histListEl.innerHTML = "";

      if(!total){
        histListEl.innerHTML = `<div style="color:rgba(255,255,255,0.65); font-weight:900; padding:10px 0;">Aucune vidéo pour l’instant.</div>`;
        return;
      }

      const list = arr.slice().reverse();

      for(const item of list){
        const ch = channelByKey(item.chKey);
        if(!ch) continue;

        const id = item.id;
        const url = `https://www.youtube.com/watch?v=${id}`;
        const meta = resolveMetaThumbTitle(ch, id);

        const row = document.createElement("div");
        row.className = "history-item";

        const img = document.createElement("img");
        img.className = "thumb";
        img.alt = "Miniature";
        img.loading = "lazy";
        if(meta.thumb) img.src = meta.thumb;

        const left = document.createElement("div");
        left.className = "history-left";

        const titleEl = document.createElement("div");
        titleEl.className = "history-title";
        titleEl.textContent = meta.title;

        const idEl = document.createElement("div");
        idEl.className = "history-id";
        idEl.textContent = `${ch.name} • ${id}`;

        const link = document.createElement("a");
        link.className = "history-link";
        link.href = url;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.textContent = url;

        left.appendChild(titleEl);
        left.appendChild(idEl);
        left.appendChild(link);

        const copyBtn = document.createElement("button");
        copyBtn.className = "small-btn";
        copyBtn.textContent = "Copier";
        copyBtn.addEventListener("click", async ()=>{
          try{
            await navigator.clipboard.writeText(url);
            copyBtn.textContent = "Copié ✅";
            setTimeout(()=>copyBtn.textContent="Copier", 900);
          }catch{
            alert("Impossible de copier (autorisation navigateur).");
          }
        });

        row.appendChild(img);
        row.appendChild(left);
        row.appendChild(copyBtn);
        histListEl.appendChild(row);
      }
    }

    function renderHistoryChannel(){
      const chKey = histSelect.value;
      const ch = channelByKey(chKey);
      if(!ch){
        histTopline.textContent = "";
        histListEl.innerHTML = "";
        return;
      }

      const seen = loadSeenList(ch).slice().reverse();
      histTopline.textContent = `${ch.name} — ${seen.length} vidéo(s)`;

      histListEl.innerHTML = "";
      if(seen.length === 0){
        histListEl.innerHTML = `<div style="color:rgba(255,255,255,0.65); font-weight:900; padding:10px 0;">Aucune vidéo pour l’instant.</div>`;
        return;
      }

      for(const id of seen){
        const url = `https://www.youtube.com/watch?v=${id}`;
        const meta = resolveMetaThumbTitle(ch, id);

        const row = document.createElement("div");
        row.className = "history-item";

        const img = document.createElement("img");
        img.className = "thumb";
        img.alt = "Miniature";
        img.loading = "lazy";
        if(meta.thumb) img.src = meta.thumb;

        const left = document.createElement("div");
        left.className = "history-left";

        const titleEl = document.createElement("div");
        titleEl.className = "history-title";
        titleEl.textContent = meta.title;

        const idEl = document.createElement("div");
        idEl.className = "history-id";
        idEl.textContent = id;

        const link = document.createElement("a");
        link.className = "history-link";
        link.href = url;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.textContent = url;

        left.appendChild(titleEl);
        left.appendChild(idEl);
        left.appendChild(link);

        const copyBtn = document.createElement("button");
        copyBtn.className = "small-btn";
        copyBtn.textContent = "Copier";
        copyBtn.addEventListener("click", async ()=>{
          try{
            await navigator.clipboard.writeText(url);
            copyBtn.textContent = "Copié ✅";
            setTimeout(()=>copyBtn.textContent="Copier", 900);
          }catch{
            alert("Impossible de copier (autorisation navigateur).");
          }
        });

        row.appendChild(img);
        row.appendChild(left);
        row.appendChild(copyBtn);
        histListEl.appendChild(row);
      }
    }

    function renderHistoryPage(){
      if(!histSelect.options.length) buildChannelSelect();

      histModeGlobalBtn.classList.toggle("active", histMode === "global");
      histModeChannelBtn.classList.toggle("active", histMode === "channel");
      histPickerWrap.classList.toggle("hidden", histMode !== "channel");

      if(histMode === "global") renderHistoryGlobal();
      else renderHistoryChannel();
    }

    histModeGlobalBtn.addEventListener("click", ()=>{ histMode = "global"; renderHistoryPage(); });
    histModeChannelBtn.addEventListener("click", ()=>{ histMode = "channel"; renderHistoryPage(); });
    histSelect.addEventListener("change", renderHistoryPage);

    histCopyBtn.addEventListener("click", async ()=>{
      try{
        const lines = [];
        if(histMode === "global"){
          const arr = loadGlobalHistory().slice().reverse();
          for(const it of arr){
            if(it?.id) lines.push(`https://www.youtube.com/watch?v=${it.id}`);
          }
        }else{
          const ch = channelByKey(histSelect.value);
          const seen = ch ? loadSeenList(ch).slice().reverse() : [];
          for(const id of seen) lines.push(`https://www.youtube.com/watch?v=${id}`);
        }
        await navigator.clipboard.writeText(lines.join("\n"));
        toast("Historique copié ✅");
      }catch{
        alert("Impossible de copier (autorisation navigateur).");
      }
    });

    histClearBtn.addEventListener("click", ()=>{
      if(histMode === "global"){
        resetSeenAll();
        toast("Historique global supprimé ✅");
      }else{
        const ch = channelByKey(histSelect.value);
        if(ch){
          resetSeenForChannel(ch);
          toast(`Historique supprimé : ${ch.name} ✅`);
        }
      }
      renderChannels();
      renderFavorites();
      renderHistoryPage();
    });

    /* ========= ACTIONS ========= */
    const rebuildAllBtn = document.getElementById("rebuild-all-btn");
    const rebuildLatestBtn = document.getElementById("rebuild-latest-btn");

    rebuildAllBtn.addEventListener("click", async ()=>{
      try{
        showOverlay("Rebuild caches…", "Rebuild de toutes les chaînes (anti-shorts)…");
        for(const ch of CHANNELS_ALL){
          toast(`Rebuild… ${ch.name}`);
          await buildPoolForChannel(ch, true);
        }
        toast("✅ Rebuild terminé.");
        renderChannels();
        renderFavorites();
        if(document.getElementById("page-history")?.classList.contains("active")) renderHistoryPage();
      }catch(e){
        console.error(e);
        toast("Erreur : " + (e.message || e));
      }finally{
        hideOverlay();
      }
    });

    rebuildLatestBtn.addEventListener("click", async ()=>{
      try{
        showOverlay("Dernières vidéos…", "Mise à jour des dernières vidéos (cache 6h)…");
        const ids = uniqueLatestChannelIds();
        for(const id of ids) clearLatest(id);
        for(const id of ids){
          toast("Dernière vidéo…");
          await fetchLatestVideo(id);
        }
        toast("✅ Dernières vidéos mises à jour.");
        renderChannels();
        renderFavorites();
      }catch(e){
        console.error(e);
        toast("Erreur : " + (e.message || e));
      }finally{
        hideOverlay();
      }
    });

    /* ========= BOOT ========= */
    (function boot(){
      renderOptionsUI();
      renderChannels();
      renderFavorites();
      buildChannelSelect();

      // ✅ accelère la 1ère lecture en modal (précharge l’API si embed ON et pas en local file://)
      if(isEmbedEnabled()){
        // petit delay pour ne pas bloquer le rendu
        setTimeout(()=> ensureYouTubeIframeApi(true), 250);
      }

      if(IS_FILE){
        toast("Mode local (file://) : lecteur intégré désactivé (erreur 153).");
      }
    })();

  </script>
</body>
</html>
